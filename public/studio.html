<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <title>Page Compliance Studio | Croutons</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    [v-cloak] { display: none; }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #F8F8F8;
    }
    code, .font-mono { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
    }
    /* NEOBRUTALIST BUTTONS */
    button { 
      border-radius: 0 !important; 
      font-weight: 500; 
      transition: all 0.2s ease;
    }
    button:hover:not(:disabled) { 
      transform: translate(-2px, -2px);
    }
    button.btn-primary {
      box-shadow: 4px 4px 0px 0px rgba(0, 194, 255, 0.3);
    }
    button.btn-primary:hover:not(:disabled) {
      box-shadow: 6px 6px 0px 0px rgba(0, 194, 255, 0.4);
    }
    button.btn-secondary {
      box-shadow: 4px 4px 0px 0px rgba(10, 10, 10, 0.2);
    }
    button.btn-secondary:hover:not(:disabled) {
      box-shadow: 6px 6px 0px 0px rgba(10, 10, 10, 0.3);
    }
    input, select, textarea { border-radius: 0 !important; }
    .check-pass { color: #10B981; }
    .check-fail { color: #EF4444; }
    .check-pending { color: #F59E0B; }
    .word-count { font-size: 0.75rem; color: #6B6B6B; }
    
    /* NEOBRUTALIST CARDS */
    .neo-card { 
      transition: all 0.2s ease;
      box-shadow: 8px 8px 0px 0px rgba(10, 10, 10, 0.1);
    }
    .neo-card:hover { 
      box-shadow: 10px 10px 0px 0px rgba(10, 10, 10, 0.15);
      transform: translate(-2px, -2px);
    }
    .neo-card-sm {
      box-shadow: 6px 6px 0px 0px rgba(10, 10, 10, 0.1);
    }
    .neo-card-sm:hover {
      box-shadow: 8px 8px 0px 0px rgba(10, 10, 10, 0.15);
    }
  </style>
</head>
<body>
  <div id="app" v-cloak>
    <!-- Header -->
    <section class="w-full bg-white py-8 px-4 md:px-8 border-b-2 border-[#0A0A0A]">
      <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-3xl font-bold text-[#0A0A0A]">Page Compliance Studio</h1>
            <p class="text-sm text-[#6B6B6B] mt-1">AEO/GEO Content Production • Croutons Protocol A-J</p>
          </div>
          <div class="flex gap-3">
            <button @click="view='list'" 
                    :class="view==='list' ? 'bg-[#0A0A0A] text-white btn-secondary' : 'bg-white text-[#0A0A0A] border-2 border-[#0A0A0A] btn-secondary'"
                    class="px-6 py-2 font-medium uppercase tracking-wide text-sm">
              My Pages
            </button>
            <button @click="startNewPage" 
                    class="px-6 py-2 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF] font-medium uppercase tracking-wide text-sm btn-primary">
              + New Page
            </button>
          </div>
        </div>
        
        <!-- Mode Toggle -->
        <div v-if="view==='editor'" class="flex items-center gap-2 text-xs">
          <span class="text-[#6B6B6B]">Mode:</span>
          <button @click="editorMode='simple'" 
                  :class="editorMode==='simple' ? 'bg-[#0A0A0A] text-white' : 'bg-[#E5E5E5] text-[#0A0A0A]'"
                  class="px-3 py-1">
            Simple (Writers)
          </button>
          <button @click="editorMode='advanced'" 
                  :class="editorMode==='advanced' ? 'bg-[#0A0A0A] text-white' : 'bg-[#E5E5E5] text-[#0A0A0A]'"
                  class="px-3 py-1">
            Advanced (Developers)
          </button>
        </div>
      </div>
    </section>

    <!-- API Key Gate -->
    <div v-if="!apiKey" class="max-w-2xl mx-auto mt-12 px-4">
      <div class="bg-white border-2 border-[#0A0A0A] p-8 neo-card">
        <h2 class="text-2xl font-bold mb-4">Studio Access Required</h2>
        <p class="text-[#6B6B6B] mb-6">Enter your Studio API key to access Page Compliance Studio. Contact your team lead for access.</p>
        <input v-model="apiKeyInput" 
               type="password" 
               placeholder="Paste API key here"
               class="w-full border-2 border-[#0A0A0A] px-4 py-3 mb-4 font-mono text-sm"
               @keyup.enter="setApiKey">
        <button @click="setApiKey" 
                class="w-full bg-[#0A0A0A] text-white px-6 py-3 font-medium uppercase tracking-wide btn-secondary">
          Access Studio
        </button>
      </div>
    </div>

    <!-- Page List -->
    <div v-if="apiKey && view==='list'" class="max-w-7xl mx-auto mt-8 px-4">
      <div v-if="loading" class="text-center py-12 text-[#6B6B6B]">Loading pages...</div>
      
      <div v-else-if="pages.length === 0" class="text-center py-12">
        <p class="text-[#6B6B6B] mb-6">No pages yet. Create your first AEO/GEO-compliant page.</p>
        <button @click="startNewPage" 
                class="px-8 py-3 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF] font-medium uppercase tracking-wide btn-primary">
          + Create First Page
        </button>
      </div>
      
      <div v-else class="grid gap-4">
        <div v-for="page in pages" :key="page.id" 
             @click="editPage(page.id)"
             class="bg-white border-2 border-[#0A0A0A] p-6 cursor-pointer neo-card">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <h3 class="text-lg font-bold text-[#0A0A0A] mb-1">{{ page.domain }}{{ page.path }}</h3>
              <p class="text-sm text-[#6B6B6B] capitalize">{{ page.page_type.replace('_', ' ') }}</p>
            </div>
            <span class="px-3 py-1 bg-[#E5E5E5] text-[#0A0A0A] text-xs font-mono">
              ID: {{ page.id }}
            </span>
          </div>
          <div class="flex items-center gap-4 text-xs text-[#6B6B6B]">
            <span>Updated {{ new Date(page.updated_at).toLocaleDateString() }}</span>
            <span>•</span>
            <span class="font-mono">{{ page.content_hash?.substring(0, 12) || 'No hash' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Editor View -->
    <div v-if="apiKey && view==='editor'" class="max-w-7xl mx-auto mt-8 px-4 pb-12">
      
      <!-- Simple Mode (Content Writers) -->
      <div v-if="editorMode==='simple'" class="space-y-6">
        
        <!-- AI GENERATOR INLINE -->
        <div class="bg-white border-2 border-[#0A0A0A] p-6 neo-card-sm">
          <div class="mb-6 p-4 bg-[#00C2FF] bg-opacity-10 border-l-4 border-[#00C2FF]">
            <h2 class="text-lg font-bold mb-2">AI GENERATE FROM TOPIC</h2>
            <p class="text-sm text-[#6B6B6B] mb-4">Enter a topic below and AI will fill out all fields automatically. Or skip and fill manually.</p>
            
            <div class="space-y-3">
              <input v-model="aiPrompt.topic" 
                     placeholder="Topic: e.g., How to verify business identity with LLMs"
                     class="w-full border-2 border-[#0A0A0A] px-4 py-2">
              
              <textarea v-model="aiPrompt.context" 
                        placeholder="Additional context (optional): Target audience, specific things to mention, etc."
                        rows="2"
                        class="w-full border-2 border-[#0A0A0A] px-4 py-2"></textarea>
              
              <div class="flex gap-3">
                <button @click="generateAndApply" 
                        :disabled="generating || !aiPrompt.topic"
                        class="flex-1 px-6 py-3 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF] font-bold uppercase disabled:opacity-50 btn-primary">
                  {{ generating ? 'GENERATING...' : 'GENERATE & FILL FORM' }}
                </button>
              </div>
            </div>
          </div>
          
          <h2 class="text-xl font-bold mb-4">Page Details</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Content Type</label>
              <select v-model="currentPage.page_type" class="w-full border-2 border-[#0A0A0A] px-4 py-2">
                <option value="blog">Blog Post / Article</option>
                <option value="landing">Landing Page</option>
                <option value="product">Product Page</option>
                <option value="product_marketing">Product Marketing</option>
                <option value="faq">FAQ / Help</option>
                <option value="home">Homepage</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">URL Path</label>
              <input v-model="currentPage.path" 
                     placeholder="/blog/my-article"
                     class="w-full border-2 border-[#0A0A0A] px-4 py-2">
            </div>
          </div>
        </div>

        <!-- CROUTONIZER PANEL (Real-Time Semantic Compiler) -->
        <div v-if="simpleData.title && simpleData.answerBox && simpleData.sections.some(s => s.content)"
             class="bg-white border-4 border-[#0A0A0A] p-6 neo-card-sm mb-6" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.02) 10px, rgba(0,0,0,0.02) 20px);">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">CROUTONIZER SCORE</h2>
            <div class="text-6xl font-bold">
              {{ croutonizerLiveScore }}<span class="text-3xl text-gray-500">/100</span>
            </div>
          </div>
          
          <div class="grid grid-cols-5 gap-3 mb-4">
            <div class="bg-white border-2 border-[#0A0A0A] p-3 text-center">
              <div :class="guardrails.sectionalAnchoring.pass ? 'text-[#10B981]' : 'text-[#EF4444]'" class="text-3xl font-bold mb-1">
                {{ guardrails.sectionalAnchoring.pass ? '✓' : '✗' }}
              </div>
              <div class="text-xs font-bold text-gray-700">ANCHORING</div>
            </div>
            <div class="bg-white border-2 border-[#0A0A0A] p-3 text-center">
              <div :class="guardrails.entityPersistence.pass ? 'text-[#10B981]' : 'text-[#EF4444]'" class="text-3xl font-bold mb-1">
                {{ guardrails.entityPersistence.pass ? '✓' : '✗' }}
              </div>
              <div class="text-xs font-bold text-gray-700">ENTITIES</div>
            </div>
            <div class="bg-white border-2 border-[#0A0A0A] p-3 text-center">
              <div :class="guardrails.claimEvidence.pass ? 'text-[#10B981]' : 'text-[#EF4444]'" class="text-3xl font-bold mb-1">
                {{ guardrails.claimEvidence.pass ? '✓' : '✗' }}
              </div>
              <div class="text-xs font-bold text-gray-700">EVIDENCE</div>
            </div>
            <div class="bg-white border-2 border-[#0A0A0A] p-3 text-center">
              <div :class="guardrails.queryHeaders.pass ? 'text-[#10B981]' : 'text-[#EF4444]'" class="text-3xl font-bold mb-1">
                {{ guardrails.queryHeaders.pass ? '✓' : '✗' }}
              </div>
              <div class="text-xs font-bold text-gray-700">HEADERS</div>
            </div>
            <div class="bg-white border-2 border-[#0A0A0A] p-3 text-center">
              <div :class="guardrails.factDensity.pass ? 'text-[#10B981]' : 'text-[#EF4444]'" class="text-3xl font-bold mb-1">
                {{ guardrails.factDensity.pass ? '✓' : '✗' }}
              </div>
              <div class="text-xs font-bold text-gray-700">DENSITY</div>
            </div>
          </div>
          
          <div v-if="croutonizerWarnings.length > 0" class="space-y-2">
            <div v-for="(warning, i) in (showAllWarnings ? croutonizerWarnings : croutonizerWarnings.slice(0, 3))" :key="i" 
                 class="bg-white border-2 border-[#F59E0B] p-3 text-sm">
              <div class="flex items-start justify-between mb-2">
                <div class="font-bold text-[#F59E0B]">{{ warning.type.toUpperCase() }}</div>
                <button v-if="warning.fixable" 
                        @click="autoFixIssue(warning)"
                        class="px-3 py-1 bg-[#10B981] text-white text-xs font-bold border-2 border-[#0A0A0A] hover:bg-[#059669]">
                  FIX
                </button>
              </div>
              <div class="text-[#0A0A0A] mb-1">{{ warning.message }}</div>
              <div v-if="warning.suggestion" class="text-gray-700 text-xs mt-2">
                <strong>Fix:</strong> {{ warning.suggestion }}
              </div>
            </div>
            <button v-if="croutonizerWarnings.length > 3 && !showAllWarnings" 
                    @click="showAllWarnings = true"
                    class="w-full py-2 text-center text-sm text-gray-700 font-medium border-2 border-gray-300 bg-gray-50 hover:bg-gray-100">
              Show +{{ croutonizerWarnings.length - 3 }} more issues
            </button>
            <button v-if="showAllWarnings && croutonizerWarnings.length > 3" 
                    @click="showAllWarnings = false"
                    class="w-full py-2 text-center text-sm text-gray-700 font-medium border-2 border-gray-300 bg-gray-50 hover:bg-gray-100">
              Show less
            </button>
          </div>
        </div>

        <!-- AEO/GEO Checklist -->
        <div class="bg-white border-2 border-[#0A0A0A] p-6 neo-card-sm">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">Writer Checklist</h2>
            <div class="text-sm">
              <span :class="checklistScore >= 8 ? 'check-pass' : 'check-fail'" class="font-bold">
                {{ checklistScore }}/12 Complete
              </span>
            </div>
          </div>

          <!-- 1. Title + Thesis -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="simpleData.title.length > 5 ? 'check-pass' : 'check-fail'">
                {{ simpleData.title.length > 5 ? '✓' : '○' }}
              </span>
              <h3 class="font-bold">1. Title + One-Line Thesis</h3>
            </div>
            <input v-model="simpleData.title" 
                   placeholder="Title: Specific outcome/mechanism, not generic"
                   class="w-full border-2 border-[#0A0A0A] px-4 py-3 mb-3">
            <textarea v-model="simpleData.thesis" 
                      placeholder="One declarative sentence stating the main claim"
                      rows="2"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3"></textarea>
          </div>

          <!-- 2. Answer Box -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="answerBoxValid ? 'check-pass' : 'check-fail'">
                {{ answerBoxValid ? '✓' : '○' }}
              </span>
              <h3 class="font-bold">2. Answer Box (40-60 words)</h3>
              <span class="word-count ml-auto">{{ answerBoxWordCount }} words</span>
            </div>
            <p class="text-xs text-[#6B6B6B] mb-3">
              AI-quotable snippet: (1) Situation/context, (2) Key claim, (3) Mechanism/why
            </p>
            <textarea v-model="simpleData.answerBox" 
                      placeholder="Write a 40-60 word snippet that stands alone. No warm-up phrases."
                      rows="4"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3"></textarea>
          </div>

          <!-- 3. Key Facts -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="keyFactsValid ? 'check-pass' : 'check-fail'">
                {{ keyFactsValid ? '✓' : '○' }}
              </span>
              <h3 class="font-bold">3. Key Facts (8-15 atomic lines)</h3>
              <span class="word-count ml-auto">{{ keyFactsCount }} facts</span>
            </div>
            <p class="text-xs text-[#6B6B6B] mb-3">
              One fact per line. No pronouns. Format: "X is Y" / "X causes Y by Z" / "X requires Y when Z"
            </p>
            
            <!-- AI Extract Button -->
            <div class="mb-3 flex gap-2">
              <button @click="extractFactsAI" 
                      :disabled="extracting || !currentPage.id"
                      class="px-4 py-2 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF] font-medium uppercase tracking-wide text-sm disabled:opacity-50 disabled:cursor-not-allowed btn-primary">
                {{ extracting ? 'EXTRACTING...' : 'EXTRACT FACTS' }}
              </button>
              <span v-if="extractedFactsCount > 0" class="text-xs text-[#25D366] self-center">
                {{ extractedFactsCount }} facts extracted
              </span>
            </div>
            
            <textarea v-model="simpleData.keyFacts" 
                      placeholder="Entity X defines a stable identifier for disambiguation.&#10;Comparison tables require at least three columns to preserve context.&#10;Evidence-based identity reduces ambiguity in entity matching by 40%."
                      rows="10"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 font-mono text-sm"></textarea>
          </div>

          <!-- 4. H2 Sections -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="sectionsValid ? 'check-pass' : 'check-fail'">
                {{ sectionsValid ? '✓' : '○' }}
              </span>
              <h3 class="font-bold">4. Main Sections (3-6 H2s)</h3>
              <span class="word-count ml-auto">{{ simpleData.sections.length }} sections</span>
            </div>
            <p class="text-xs text-[#6B6B6B] mb-3">
              Each section: definition/constraint + information gain (number/rule/comparison/checklist)
            </p>
            <div v-for="(section, i) in simpleData.sections" :key="i" class="mb-3 bg-[#F8F8F8] p-4">
              <input v-model="section.heading" 
                     :placeholder="'H2 #' + (i+1) + ': Entity/Mechanism/Question'"
                     class="w-full border-2 border-[#0A0A0A] px-3 py-2 mb-2">
              <textarea v-model="section.content" 
                        placeholder="Definition/constraint + one information-gain item (number/rule/comparison)"
                        rows="3"
                        class="w-full border-2 border-[#0A0A0A] px-3 py-2 text-sm"></textarea>
              <button @click="simpleData.sections.splice(i, 1)" 
                      class="mt-2 px-3 py-1 bg-[#E5E5E5] text-[#0A0A0A] text-xs border border-[#0A0A0A]">
                Remove Section
              </button>
            </div>
            <button @click="simpleData.sections.push({heading: '', content: ''})" 
                    class="w-full px-4 py-2 bg-[#E5E5E5] text-[#0A0A0A] border-2 border-[#0A0A0A] btn-secondary">
              + Add Section
            </button>
          </div>

          <!-- 5. Structured Asset -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="simpleData.structuredAsset.length > 20 ? 'check-pass' : 'check-fail'">
                {{ simpleData.structuredAsset.length > 20 ? '✓' : '○' }}
              </span>
              <h3 class="font-bold">5. Structured Asset (required)</h3>
            </div>
            <p class="text-xs text-[#6B6B6B] mb-3">
              Choose ONE: Table (3+ cols) / Technical list / Decision rubric / Field spec
            </p>
            <textarea v-model="simpleData.structuredAsset" 
                      placeholder="Paste your table, list, rubric, or spec here (markdown/CSV/plain text)"
                      rows="8"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 font-mono text-sm"></textarea>
            
            <!-- Table Preview (if table format detected) -->
            <div v-if="simpleData.structuredAsset && (simpleData.structuredAsset.includes('|') || simpleData.structuredAsset.includes('\t'))" 
                 class="mt-4 border-2 border-[#0A0A0A] p-4 bg-white">
              <div class="text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">Preview (Copy-ready table)</div>
              <div v-html="convertToHTMLTable(simpleData.structuredAsset)" class="overflow-x-auto"></div>
              <style>
                table { border-collapse: collapse; width: 100%; margin-top: 8px; }
                th, td { border: 2px solid #0A0A0A; padding: 8px 12px; text-align: left; }
                th { background: #F3F4F6; font-weight: bold; }
                td { background: white; }
              </style>
            </div>
          </div>

          <!-- 6. What This Means -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="simpleData.implications.length > 10 && simpleData.nextActions.length > 10 ? 'check-pass' : 'check-fail'">
                {{ simpleData.implications.length > 10 && simpleData.nextActions.length > 10 ? '✓' : '○' }}
              </span>
              <h3 class="font-bold">6. What This Means (actionable closure)</h3>
            </div>
            <label class="block text-sm font-medium mb-2">Implications (3-5 bullets):</label>
            <textarea v-model="simpleData.implications" 
                      placeholder="• Implication 1: what changes&#10;• Implication 2: what to watch&#10;• Implication 3: what becomes possible"
                      rows="4"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 mb-3 text-sm"></textarea>
            
            <label class="block text-sm font-medium mb-2">Next Actions (3-5 bullets):</label>
            <textarea v-model="simpleData.nextActions" 
                      placeholder="• Action 1: concrete step&#10;• Action 2: concrete step&#10;• Action 3: concrete step"
                      rows="4"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 mb-3 text-sm"></textarea>
            
            <label class="block text-sm font-medium mb-2">First 30 Minutes:</label>
            <input v-model="simpleData.first30Min" 
                   placeholder="One immediate action a reader can execute quickly"
                   class="w-full border-2 border-[#0A0A0A] px-4 py-2 text-sm">
          </div>

          <!-- 7. Related Resources -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="simpleData.relatedResources.length > 10 ? 'check-pass' : 'check-fail'">
                {{ simpleData.relatedResources.length > 10 ? '✓' : '○' }}
              </span>
              <h3 class="font-bold">7. Related Resources (internal links)</h3>
            </div>
            <textarea v-model="simpleData.relatedResources" 
                      placeholder="Parent pillar: [slug or title]&#10;Related page: [slug or title]&#10;Related page: [slug or title]"
                      rows="4"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 text-sm"></textarea>
          </div>

          <!-- 8. FAQ -->
          <div class="mb-6">
            <div class="flex items-center gap-2 mb-3">
              <span :class="faqValid ? 'check-pass' : 'check-fail'">
                {{ faqValid ? '✓' : '○' }}
              </span>
              <h3 class="font-bold">8. FAQ (3-5 Q&As, <50 words each)</h3>
              <span class="word-count ml-auto">{{ simpleData.faq.length }} Q&As</span>
            </div>
            <div v-for="(qa, i) in simpleData.faq" :key="i" class="mb-4 bg-[#F8F8F8] p-4">
              <input v-model="qa.question" 
                     :placeholder="'Question ' + (i+1)"
                     class="w-full border-2 border-[#0A0A0A] px-3 py-2 mb-2">
              <textarea v-model="qa.answer" 
                        placeholder="Short answer (<50 words): definition / yes-no + condition / number + scope / step"
                        rows="3"
                        class="w-full border-2 border-[#0A0A0A] px-3 py-2 text-sm mb-2"></textarea>
              <div class="flex items-center justify-between">
                <span class="text-xs" :class="qa.answer.split(' ').length <= 50 ? 'check-pass' : 'check-fail'">
                  {{ qa.answer.split(' ').filter(w => w).length }} words
                </span>
                <button @click="simpleData.faq.splice(i, 1)" 
                        class="px-3 py-1 bg-[#E5E5E5] text-[#0A0A0A] text-xs border border-[#0A0A0A]">
                  Remove
                </button>
              </div>
            </div>
            <button @click="simpleData.faq.push({question: '', answer: ''})" 
                    class="w-full px-4 py-2 bg-[#E5E5E5] text-[#0A0A0A] border-2 border-[#0A0A0A] btn-secondary">
              + Add Q&A
            </button>
          </div>
        </div>

        <!-- Actions -->
        <div class="space-y-4">
          <!-- PRIMARY: COPY FOR CMS -->
          <button v-if="simpleData.title && simpleData.answerBox"
                  @click="copyForCMS" 
                  class="w-full px-8 py-8 bg-[#10B981] text-white font-bold uppercase tracking-wide text-2xl border-4 border-[#0A0A0A] shadow-[12px_12px_0px_0px_rgba(0,0,0,0.4)] hover:shadow-[16px_16px_0px_0px_rgba(0,0,0,0.5)] transition-all">
            COPY FOR CMS
          </button>
          
          <!-- SECONDARY: SAVE -->
          <button @click="saveSimplePage" 
                  :disabled="saving || checklistScore < 8"
                  class="w-full px-8 py-4 bg-[#0A0A0A] text-white font-bold uppercase tracking-wide text-lg border-4 border-[#0A0A0A] disabled:opacity-50 hover:bg-gray-800 transition-all">
            {{ saving ? 'SAVING...' : 'SAVE CONTENT' }}
          </button>
          
          <!-- DEVELOPER TOOLS (COLLAPSIBLE) -->
          <details class="bg-gray-50 border-2 border-gray-300 p-4">
            <summary class="cursor-pointer font-bold text-sm text-gray-700 uppercase tracking-wide">Developer Tools</summary>
            <div class="mt-4 space-y-3">
              <button @click="copyTablesTSV" 
                      v-if="simpleData.structuredAsset"
                      class="w-full px-4 py-3 bg-white text-[#0A0A0A] border-2 border-[#0A0A0A] font-medium uppercase text-sm hover:bg-gray-50">
                Copy Tables (TSV)
              </button>
              <button @click="copyConnectorScript" 
                      class="w-full px-4 py-3 bg-white text-[#0A0A0A] border-2 border-[#0A0A0A] font-medium uppercase text-sm hover:bg-gray-50">
                Get Connector Script
              </button>
              <button @click="runCroutonizerFromButton" 
                      :disabled="croutonizing || !currentPage.id"
                      class="w-full px-4 py-3 bg-white text-[#0A0A0A] border-2 border-[#0A0A0A] font-medium uppercase text-sm disabled:opacity-50 hover:bg-gray-50">
                {{ croutonizing ? 'Analyzing...' : 'Run Compiler' }}
              </button>
            </div>
          </details>
          
          <div class="bg-[#F8F8F8] border-2 border-[#E5E5E5] p-4 text-center">
            <div class="text-sm text-[#6B6B6B] mb-2">
              <strong>For Developers Only:</strong> Need technical files (markdown, JSON-LD, NDJSON)?
            </div>
            <button @click="editorMode='advanced'" 
                    class="px-6 py-2 bg-white text-[#0A0A0A] border-2 border-[#0A0A0A] font-medium text-sm hover:bg-[#0A0A0A] hover:text-white btn-secondary">
              → Switch to Developer Mode
            </button>
          </div>
        </div>

        <div v-if="checklistScore < 8" class="bg-[#FEF3C7] border-2 border-[#F59E0B] p-4 text-sm">
          <strong>⚠ Complete More Items:</strong> Fill in at least 8/12 checklist items to save your content.
        </div>
      </div>

      <!-- Advanced Mode (Developers) -->
      <div v-if="editorMode==='advanced'" class="bg-white border-2 border-[#0A0A0A] p-6">
        <h2 class="text-xl font-bold mb-4">Advanced Mode (Developer View)</h2>
        <p class="text-sm text-[#6B6B6B] mb-6">
          Direct access to facts, sections, and protocol internals. For technical users only.
        </p>
        <div class="bg-[#F8F8F8] p-4 rounded font-mono text-sm">
          <pre>{{ JSON.stringify(currentPage, null, 2) }}</pre>
        </div>
        <button @click="editorMode='simple'" 
                class="mt-4 px-6 py-2 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF] btn-primary">
          ← Back to Simple Mode
        </button>
      </div>
    </div>

    <!-- Artifacts View -->
    <div v-if="apiKey && view==='artifacts'" class="max-w-7xl mx-auto mt-8 px-4 pb-12">
      <div class="bg-white border-2 border-[#0A0A0A] p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Generated Artifacts</h2>
          <button @click="view='editor'" 
                  class="px-4 py-2 bg-[#E5E5E5] text-[#0A0A0A]">
            ← Back to Editor
          </button>
        </div>
        <p class="text-sm text-[#6B6B6B]">
          Download these files and add them to your page deployment.
        </p>
      </div>

      <div v-for="(artifact, key) in artifacts" :key="key" class="bg-white border-2 border-[#0A0A0A] p-6 mb-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-lg capitalize">{{ key.replace('_', ' ') }}</h3>
          <button @click="downloadArtifact(key)" 
                  class="px-4 py-2 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF]">
            Download
          </button>
        </div>
        <pre class="bg-[#F8F8F8] p-4 overflow-x-auto text-xs font-mono border-2 border-[#E5E5E5]">{{ artifact }}</pre>
      </div>
    </div>

    <!-- Compliance View -->
    <div v-if="apiKey && view==='compliance'" class="max-w-5xl mx-auto mt-8 px-4 pb-12">
      <div class="bg-white border-2 border-[#0A0A0A] p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Protocol Compliance (A-J)</h2>
          <button @click="view='editor'" 
                  class="px-4 py-2 bg-[#E5E5E5] text-[#0A0A0A]">
            ← Back to Editor
          </button>
        </div>
        <div class="text-3xl font-bold" :class="complianceScore >= 8 ? 'check-pass' : 'check-fail'">
          {{ complianceScore }}/10 Checks Passing
        </div>
      </div>

      <div class="space-y-3">
        <div v-for="check in complianceChecks" :key="check.id" 
             class="bg-white border-2 border-[#0A0A0A] p-6">
          <div class="flex items-start gap-4">
            <span class="text-2xl" :class="check.status === 'pass' ? 'check-pass' : check.status === 'fail' ? 'check-fail' : 'check-pending'">
              {{ check.status === 'pass' ? '✓' : check.status === 'fail' ? '✗' : '○' }}
            </span>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-1">{{ check.id.toUpperCase() }} - {{ check.title }}</h3>
              <p class="text-sm text-[#6B6B6B] mb-2">{{ check.description }}</p>
              <p class="text-sm" :class="check.status === 'pass' ? 'check-pass' : check.status === 'fail' ? 'check-fail' : 'check-pending'">
                {{ check.message }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          apiKey: '',
          apiKeyInput: '',
          view: 'list', // list, editor, artifacts, compliance
          editorMode: 'simple', // simple, advanced
          loading: false,
          saving: false,
          extracting: false,
          extractedFactsCount: 0,
          croutonizing: false,
          croutonizerScore: {},
          croutonizerIssues: [],
          generating: false,
          aiPrompt: {
            topic: '',
            context: '',
            contentType: 'blog'
          },
          pages: [],
          currentPage: { domain: 'croutons.ai', path: '', page_type: 'blog' },
          simpleData: {
            title: '',
            thesis: '',
            answerBox: '',
            keyFacts: '',
            sections: [],
            structuredAsset: '',
            implications: '',
            nextActions: '',
            first30Min: '',
            relatedResources: '',
            faq: []
          },
          artifacts: {},
          complianceChecks: [],
          guardrails: {
            sectionalAnchoring: { pass: true, score: 100, warnings: [] },
            entityPersistence: { pass: true, score: 100, warnings: [] },
            claimEvidence: { pass: true, score: 100, warnings: [] },
            queryHeaders: { pass: true, score: 100, warnings: [] },
            factDensity: { pass: true, score: 100, warnings: [] }
          },
          croutonizerWarnings: [],
          showAllWarnings: false
        };
      },
      computed: {
        answerBoxWordCount() {
          return this.simpleData.answerBox.split(' ').filter(w => w).length;
        },
        answerBoxValid() {
          const wc = this.answerBoxWordCount;
          return wc >= 40 && wc <= 60;
        },
        keyFactsCount() {
          return this.simpleData.keyFacts.split('\n').filter(l => l.trim()).length;
        },
        keyFactsValid() {
          const count = this.keyFactsCount;
          return count >= 8 && count <= 15;
        },
        sectionsValid() {
          const count = this.simpleData.sections.filter(s => s.heading && s.content).length;
          return count >= 3 && count <= 6;
        },
        faqValid() {
          const count = this.simpleData.faq.filter(qa => qa.question && qa.answer).length;
          return count >= 3 && count <= 5;
        },
        checklistScore() {
          let score = 0;
          if (this.simpleData.title.length > 5) score++;
          if (this.simpleData.thesis.length > 10) score++;
          if (this.answerBoxValid) score++;
          if (this.keyFactsValid) score++;
          if (this.sectionsValid) score++;
          if (this.simpleData.structuredAsset.length > 20) score++;
          if (this.simpleData.implications.length > 10 && this.simpleData.nextActions.length > 10) score++;
          if (this.simpleData.first30Min.length > 5) score++;
          if (this.simpleData.relatedResources.length > 10) score++;
          if (this.faqValid) score++;
          // Terminology + red-flag check (manual, assume pass if >8)
          if (score >= 8) score += 2;
          return score;
        },
        complianceScore() {
          return this.complianceChecks.filter(c => c.status === 'pass').length;
        },
        croutonizerLiveScore() {
          const scores = Object.values(this.guardrails).map(g => g.score);
          if (scores.length === 0) return 0;
          const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
          return Math.round(avg);
        }
      },
      watch: {
        'simpleData.sections': {
          handler() {
            this.runCroutonizerChecks();
          },
          deep: true
        },
        'simpleData.keyFacts'() {
          this.runCroutonizerChecks();
        },
        'simpleData.answerBox'() {
          this.runCroutonizerChecks();
        }
      },
      mounted() {
        const saved = localStorage.getItem('studio_api_key');
        if (saved) {
          this.apiKey = saved;
          this.loadPages();
        }
        this.runCroutonizerChecks();
      },
      methods: {
        // ===== CROUTONIZER LIVE GUARDRAILS =====
        runCroutonizerChecks() {
          this.croutonizerWarnings = [];
          this.checkSectionalAnchoring();
          this.checkEntityPersistence();
          this.checkClaimEvidence();
          this.checkQueryHeaders();
          this.checkFactDensity();
        },
        checkSectionalAnchoring() {
          let score = 100;
          let warnings = [];
          
          this.simpleData.sections.forEach(section => {
            if (!section.content) return;
            const wordCount = section.content.split(/\s+/).length;
            if (wordCount > 500) {
              const hasSummary = /in short|to summarize|in summary|the key point|in essence/i.test(section.content);
              if (!hasSummary) {
                score -= 15;
                warnings.push({
                  type: 'Sectional Anchoring',
                  message: `Section "${section.heading}" (${wordCount} words) needs summary`,
                  suggestion: 'Add "In short: [key takeaway]" at end of section'
                });
              }
            }
          });
          
          this.guardrails.sectionalAnchoring = { pass: score >= 70, score: Math.max(0, score), warnings };
          this.croutonizerWarnings.push(...warnings);
        },
        checkEntityPersistence() {
          let score = 100;
          let warnings = [];
          const pronouns = /\b(it|this|that|they|them|these|those)\b/gi;
          
          this.simpleData.sections.forEach((section, sIdx) => {
            if (!section.content) return;
            const paragraphs = section.content.split('\n\n');
            paragraphs.forEach((para, pIdx) => {
              const matches = para.match(pronouns);
              if (matches && para.split(/\s+/).length > 20) {
                const hasEntity = /[A-Z][a-z]+\s+(verification|matching|system|protocol|entity|method|redirect|status|code|link|page|URL)/i.test(para);
                if (!hasEntity) {
                  score -= 10;
                  warnings.push({
                    type: 'Entity Persistence',
                    message: `Section "${section.heading}" para ${pIdx + 1} uses pronouns ambiguously`,
                    suggestion: 'Replace "it" or "this" with specific entity name',
                    fixable: true,
                    sectionIndex: sIdx,
                    paragraphIndex: pIdx,
                    fixAction: 'fix-pronouns'
                  });
                }
              }
            });
          });
          
          this.guardrails.entityPersistence = { pass: score >= 70, score: Math.max(0, score), warnings };
          this.croutonizerWarnings.push(...warnings);
        },
        checkClaimEvidence() {
          let score = 100;
          let warnings = [];
          
          if (!this.simpleData.keyFacts) {
            this.guardrails.claimEvidence = { pass: false, score: 0, warnings: [] };
            return;
          }
          
          const facts = this.simpleData.keyFacts.split('\n').filter(f => f.trim());
          const sectionHeadings = this.simpleData.sections.map(s => s.heading.toLowerCase());
          
          let unmappedFacts = 0;
          facts.forEach(fact => {
            const factWords = fact.toLowerCase().split(/\s+/).slice(0, 3);
            const mapped = sectionHeadings.some(heading => 
              factWords.some(word => heading.includes(word))
            );
            if (!mapped) unmappedFacts++;
          });
          
          if (unmappedFacts > facts.length * 0.3) {
            score = 50;
            warnings.push({
              type: 'Claim-Evidence',
              message: `${unmappedFacts} key facts don't map to section headings`,
              suggestion: 'Create H2 sections supporting your key facts or add bridging sentences',
              fixable: true,
              fixAction: 'add-sections'
            });
          }
          
          this.guardrails.claimEvidence = { pass: score >= 70, score, warnings };
          this.croutonizerWarnings.push(...warnings);
        },
        checkQueryHeaders() {
          let score = 100;
          let warnings = [];
          const genericHeaders = ['introduction', 'overview', 'conclusion', 'summary', 'background', 'about', 'info', 'details'];
          
          this.simpleData.sections.forEach((section, idx) => {
            if (!section.heading) return;
            const heading = section.heading.toLowerCase();
            const isGeneric = genericHeaders.some(g => heading === g || heading.includes(g));
            
            if (isGeneric) {
              score -= 15;
              warnings.push({
                type: 'Query-Ready Headers',
                message: `"${section.heading}" is too generic`,
                suggestion: 'Make query-specific: e.g., "How Entity Verification Works" not "Overview"',
                fixable: true,
                sectionIndex: idx,
                fixAction: 'rename-header'
              });
            }
          });
          
          this.guardrails.queryHeaders = { pass: score >= 70, score: Math.max(0, score), warnings };
          this.croutonizerWarnings.push(...warnings);
        },
        checkFactDensity() {
          let score = 100;
          let warnings = [];
          
          this.simpleData.sections.forEach(section => {
            if (!section.content) return;
            const paragraphs = section.content.split('\n\n').filter(p => p.trim());
            if (paragraphs.length < 2) return;
            
            const factIndicators = /\d+%|\d+ percent|reduces|increases|requires|defines|causes|results in|compared to/i;
            const factyParagraphs = paragraphs.filter(p => factIndicators.test(p));
            const density = factyParagraphs.length / paragraphs.length;
            
            if (density < 0.3) {
              score -= 20;
              warnings.push({
                type: 'Fact Density',
                message: `"${section.heading}" low density (${Math.round(density * 100)}%)`,
                suggestion: 'Add numbers, comparisons, definitions. Cut fluff.'
              });
            }
          });
          
          this.guardrails.factDensity = { pass: score >= 70, score: Math.max(0, score), warnings };
          this.croutonizerWarnings.push(...warnings);
        },
        autoFixIssue(warning) {
          if (warning.fixAction === 'rename-header' && warning.sectionIndex !== undefined) {
            const section = this.simpleData.sections[warning.sectionIndex];
            if (!section) return;
            
            const topicWords = this.simpleData.title.split(' ').slice(0, 4).join(' ');
            const newHeader = prompt(
              `Current header: "${section.heading}"\n\nSuggested fix:\n"How ${topicWords} Works"\n\nEnter new header:`,
              `How ${topicWords} Works`
            );
            
            if (newHeader && newHeader !== section.heading) {
              section.heading = newHeader;
              this.runCroutonizerChecks();
              alert('✓ Header updated! Score recalculated.');
            }
          }
          
          if (warning.fixAction === 'fix-pronouns' && warning.sectionIndex !== undefined && warning.paragraphIndex !== undefined) {
            const section = this.simpleData.sections[warning.sectionIndex];
            if (!section) return;
            
            const paragraphs = section.content.split('\n\n');
            const para = paragraphs[warning.paragraphIndex];
            if (!para) return;
            
            // Extract likely entity from section heading or nearby text
            const suggestedEntity = section.heading.split(' ').slice(0, 3).join(' ');
            
            const fixed = prompt(
              `Ambiguous pronouns found in:\n"${para.substring(0, 100)}..."\n\nReplace "it" or "this" with entity name:`,
              suggestedEntity
            );
            
            if (fixed) {
              paragraphs[warning.paragraphIndex] = para.replace(/\b(it|this)\b/gi, fixed);
              section.content = paragraphs.join('\n\n');
              this.runCroutonizerChecks();
              alert('✓ Pronouns fixed! Score recalculated.');
            }
          }
          
          if (warning.fixAction === 'add-sections') {
            const unmappedFacts = this.simpleData.keyFacts.split('\n').filter(f => f.trim());
            const suggestion = unmappedFacts.slice(0, 3).map(f => {
              const words = f.split(' ').slice(0, 4).join(' ');
              return `"${words}"`;
            }).join(', ');
            
            const confirm = window.confirm(
              `Add new sections for unmapped facts?\n\nSuggested sections: ${suggestion}\n\nThis will add empty sections you can fill in.`
            );
            
            if (confirm) {
              unmappedFacts.slice(0, 3).forEach(fact => {
                const heading = fact.split(' ').slice(0, 5).join(' ');
                this.simpleData.sections.push({
                  heading: `How ${heading} Works`,
                  content: ''
                });
              });
              this.runCroutonizerChecks();
              alert('✓ New sections added! Fill them in to improve score.');
            }
          }
        },
        // ===== EXISTING METHODS =====
        getScoreStatus(score) {
          if (score >= 80) return 'EXCELLENT - Ready for AI Citations';
          if (score >= 65) return 'GOOD - Minor improvements needed';
          if (score >= 40) return 'FAIR - Needs work';
          return 'NEEDS WORK - Major improvements needed';
        },
        async runCroutonizer() {
          if (!this.currentPage.id) {
            alert('Save the page first');
            return;
          }
          
          this.croutonizing = true;
          
          try {
            const res = await fetch(`/studio/pages/${this.currentPage.id}/croutonize`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({
                title: this.simpleData.title,
                answerBox: this.simpleData.answerBox,
                sections: this.simpleData.sections,
                keyFacts: this.simpleData.keyFacts
              })
            });
            
            if (!res.ok) throw new Error('Croutonizer failed');
            
            const data = await res.json();
            
            this.croutonizerScore = data.score;
            this.croutonizerIssues = data.issues || [];
            
            // Scroll to results
            setTimeout(() => {
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
            
          } catch (error) {
            console.error('Croutonizer error:', error);
            alert('Failed to run Croutonizer: ' + error.message);
          } finally {
            this.croutonizing = false;
          }
        },
        async runCroutonizerFromButton() {
          // Save first, then run
          await this.saveSimplePage();
          if (this.currentPage.id) {
            await this.runCroutonizer();
          }
        },
        setApiKey() {
          if (this.apiKeyInput) {
            this.apiKey = this.apiKeyInput;
            localStorage.setItem('studio_api_key', this.apiKey);
            this.loadPages();
          }
        },
        async loadPages() {
          this.loading = true;
          console.log('[loadPages] Starting to load pages...');
          
          try {
            // Add 10 second timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const res = await fetch('/studio/pages', {
              headers: { 'x-studio-key': this.apiKey },
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            console.log('[loadPages] Response status:', res.status);
            
            if (!res.ok) {
              // If 401, clear invalid key and show login screen
              if (res.status === 401) {
                console.error('API key invalid or missing - showing login screen');
                localStorage.removeItem('studio_api_key');
                this.apiKey = '';
                this.apiKeyInput = '';
                this.loading = false;
                alert('Invalid API key. Please enter the correct key.');
                return;
              }
              
              const error = await res.json().catch(() => ({ error: 'Unknown error' }));
              console.error('Load pages failed:', error);
              this.pages = [];
              this.loading = false;
              alert('Failed to load pages: ' + error.error);
              return;
            }
            
            const data = await res.json();
            console.log('[loadPages] API response:', data);
            
            // Handle both array format and {ok, data} format
            if (Array.isArray(data)) {
              this.pages = data;
            } else if (data.data && Array.isArray(data.data)) {
              this.pages = data.data;
            } else if (data.ok && data.data) {
              this.pages = data.data;
            } else {
              this.pages = [];
            }
            
            console.log('[loadPages] Loaded pages count:', this.pages.length);
            this.loading = false;
          } catch (err) {
            console.error('Load pages error:', err);
            this.loading = false;
            this.pages = [];
            
            if (err.name === 'AbortError') {
              alert('Loading pages timed out. Please refresh and try again.');
            } else {
              alert('Error loading pages: ' + err.message);
            }
          }
        },
        startNewPage() {
          this.currentPage = { 
            domain: 'croutons.ai', 
            path: '/blog/untitled', 
            page_type: 'blog' 
          };
          this.simpleData = {
            title: '',
            thesis: '',
            answerBox: '',
            keyFacts: '',
            sections: [
              { heading: '', content: '' },
              { heading: '', content: '' },
              { heading: '', content: '' }
            ],
            structuredAsset: '',
            implications: '',
            nextActions: '',
            first30Min: '',
            relatedResources: '',
            faq: [
              { question: '', answer: '' },
              { question: '', answer: '' },
              { question: '', answer: '' }
            ]
          };
          this.view = 'editor';
          this.editorMode = 'simple';
        },
        async editPage(id) {
          this.loading = true;
          try {
            const res = await fetch(`/studio/pages/${id}`, {
              headers: { 'x-studio-key': this.apiKey }
            });
            if (res.ok) {
              const data = await res.json();
              this.currentPage = data.page;
              // TODO: Parse technical data back into simple format
              this.view = 'editor';
            }
          } catch (err) {
            console.error('Edit page error:', err);
          }
          this.loading = false;
        },
        async saveSimplePage() {
          if (this.checklistScore < 8) {
            alert('Complete at least 8/12 checklist items before saving.');
            return;
          }

          this.saving = true;
          try {
            // Convert simple data to technical format
            const sections = this.simpleData.sections
              .filter(s => s.heading && s.content)
              .map((s, i) => ({
                anchor: s.heading.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
                heading: s.heading,
                description: s.content.substring(0, 200)
              }));

            const facts = this.simpleData.keyFacts
              .split('\n')
              .filter(l => l.trim())
              .map(line => {
                // Parse "X is Y" / "X does Y" format
                const parts = line.split(/\s+(is|are|has|does|causes|requires|includes)\s+/i);
                return {
                  subject: parts[0] || 'Unknown',
                  predicate: parts[1] || 'related_to',
                  object: parts[2] || line,
                  schema_type: 'Thing',
                  fact_category: 'content'
                };
              });

            // Create or update page
            const method = this.currentPage.id ? 'PUT' : 'POST';
            const url = this.currentPage.id 
              ? `/studio/pages/${this.currentPage.id}` 
              : '/studio/pages';

            const pageRes = await fetch(url, {
              method,
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({
                domain: this.currentPage.domain,
                path: this.currentPage.path,
                page_type: this.currentPage.page_type
              })
            });

            if (!pageRes.ok) throw new Error('Failed to save page');
            const pageData = await pageRes.json();
            this.currentPage.id = pageData.id;

            // Save sections
            await fetch(`/studio/pages/${this.currentPage.id}/sections`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({ sections })
            });

            // Save facts
            await fetch(`/studio/pages/${this.currentPage.id}/facts`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({ facts })
            });

            alert('Page saved successfully!');
            this.loadPages();
          } catch (err) {
            console.error('Save error:', err);
            alert('Error saving page: ' + err.message);
          }
          this.saving = false;
        },
        async copyForCMS() {
          // Generate clean HTML for CMS paste (NO code visible to writer)
          let html = '';
          let plainText = '';
          
          // Build semantic HTML
          html += `<article>\n`;
          html += `<h1>${this.simpleData.title}</h1>\n`;
          plainText += `${this.simpleData.title}\n\n`;
          
          if (this.simpleData.thesis) {
            html += `<p><strong>${this.simpleData.thesis}</strong></p>\n`;
            plainText += `${this.simpleData.thesis}\n\n`;
          }
          
          // Answer Box (REQUIRED near top)
          if (this.simpleData.answerBox) {
            html += `<h2>Summary</h2>\n<p>${this.simpleData.answerBox}</p>\n`;
            plainText += `Summary\n\n${this.simpleData.answerBox}\n\n`;
          }
          
          // Main Sections
          this.simpleData.sections.forEach(section => {
            if (section.heading && section.content) {
              html += `<h2>${section.heading}</h2>\n`;
              plainText += `${section.heading}\n\n`;
              
              const paragraphs = section.content.split('\n\n').filter(p => p.trim());
              paragraphs.forEach(p => {
                html += `<p>${p.trim()}</p>\n`;
                plainText += `${p.trim()}\n\n`;
              });
            }
          });
          
          // Structured Asset (as real table if possible)
          if (this.simpleData.structuredAsset) {
            const isTable = this.simpleData.structuredAsset.includes('|') || 
                           this.simpleData.structuredAsset.includes('\t');
            
            if (isTable) {
              html += this.convertToHTMLTable(this.simpleData.structuredAsset);
              plainText += `\n${this.simpleData.structuredAsset}\n\n`;
            } else {
              html += `<h2>Reference</h2>\n<pre>${this.simpleData.structuredAsset}</pre>\n`;
              plainText += `Reference\n\n${this.simpleData.structuredAsset}\n\n`;
            }
          }
          
          // What This Means
          if (this.simpleData.implications || this.simpleData.nextActions) {
            html += `<h2>What This Means</h2>\n`;
            plainText += `What This Means\n\n`;
            
            if (this.simpleData.implications) {
              html += `<h3>Implications</h3>\n<ul>\n`;
              plainText += `Implications\n\n`;
              const implications = this.simpleData.implications.split('\n').filter(l => l.trim());
              implications.forEach(imp => {
                const clean = imp.replace(/^[•\-\*]\s*/, '');
                if (clean) {
                  html += `<li>${clean}</li>\n`;
                  plainText += `- ${clean}\n`;
                }
              });
              html += `</ul>\n`;
              plainText += `\n`;
            }
            
            if (this.simpleData.nextActions) {
              html += `<h3>Next Actions</h3>\n<ul>\n`;
              plainText += `Next Actions\n\n`;
              const actions = this.simpleData.nextActions.split('\n').filter(l => l.trim());
              actions.forEach(action => {
                const clean = action.replace(/^[•\-\*]\s*/, '');
                if (clean) {
                  html += `<li>${clean}</li>\n`;
                  plainText += `- ${clean}\n`;
                }
              });
              html += `</ul>\n`;
              plainText += `\n`;
            }
            
            if (this.simpleData.first30Min) {
              html += `<p><strong>Start here:</strong> ${this.simpleData.first30Min}</p>\n`;
              plainText += `Start here: ${this.simpleData.first30Min}\n\n`;
            }
          }
          
          // FAQ
          if (this.simpleData.faq && this.simpleData.faq.some(qa => qa.question)) {
            html += `<h2>Frequently Asked Questions</h2>\n`;
            plainText += `Frequently Asked Questions\n\n`;
            this.simpleData.faq.forEach(qa => {
              if (qa.question && qa.answer) {
                html += `<h3>${qa.question}</h3>\n<p>${qa.answer}</p>\n`;
                plainText += `${qa.question}\n\n${qa.answer}\n\n`;
              }
            });
          }
          
          // Hidden payload (survives CMS paste)
          const payload = {
            hash: this.currentPage.content_hash || 'pending',
            score: Math.round((this.checklistScore / 12) * 100),
            artifacts: {
              markdown_url: `https://graph.croutons.ai/v1/artifacts/${this.currentPage.id}/markdown`,
              ndjson_url: `https://graph.croutons.ai/v1/artifacts/${this.currentPage.id}/ndjson`,
              jsonld_url: `https://graph.croutons.ai/v1/artifacts/${this.currentPage.id}/jsonld`
            }
          };
          
          html += `<div hidden data-croutons-payload='${JSON.stringify(payload)}'></div>\n`;
          html += `</article>`;
          
          // Multi-format clipboard write
          try {
            const htmlBlob = new Blob([html], { type: 'text/html' });
            const textBlob = new Blob([plainText], { type: 'text/plain' });
            
            await navigator.clipboard.write([
              new ClipboardItem({
                'text/html': htmlBlob,
                'text/plain': textBlob
              })
            ]);
            
            alert(`✓ COPIED FOR CMS!\n\nPaste into WordPress, Shopify, Webflow, Medium, or any CMS.\n\nThe article will paste with perfect formatting - headings, lists, tables, everything.`);
          } catch (err) {
            console.error('Multi-format copy failed:', err);
            // Fallback to simple text copy
            await navigator.clipboard.writeText(html);
            alert(`Copied! (Note: Your browser doesn't support rich paste. HTML copied as text.)`);
          }
        },
        async generateAndApply() {
          if (!this.aiPrompt.topic) {
            alert('Please enter a topic first.');
            return;
          }

          this.generating = true;

          try {
            const res = await fetch('/studio/generate-content', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({
                topic: this.aiPrompt.topic,
                context: this.aiPrompt.context,
                contentType: this.aiPrompt.contentType || 'blog'
              })
            });

            if (!res.ok) {
              // If 401, clear invalid key and show login screen
              if (res.status === 401) {
                console.error('API key invalid - showing login screen');
                localStorage.removeItem('studio_api_key');
                this.apiKey = '';
                this.apiKeyInput = '';
                this.generating = false;
                alert('Invalid API key. Please refresh and enter the correct key.');
                return;
              }
              
              const error = await res.json();
              throw new Error(error.error || 'Failed to generate content');
            }

            const data = await res.json();
            console.log('[generateAndApply] Received:', data);
            
            if (!data.content) {
              throw new Error('No content received from API');
            }
            
            const generated = data.content;
            
            console.log('[generateAndApply] Generated content:', JSON.stringify(generated, null, 2));
            
            // Apply each field individually with Vue reactivity
            this.simpleData.title = generated.title || '';
            this.simpleData.thesis = generated.thesis || '';
            this.simpleData.answerBox = generated.answerBox || '';
            this.simpleData.keyFacts = generated.keyFacts || '';
            this.simpleData.structuredAsset = generated.structuredAsset || '';
            this.simpleData.implications = generated.implications || '';
            this.simpleData.nextActions = generated.nextActions || '';
            this.simpleData.first30Min = generated.first30Min || '';
            this.simpleData.relatedResources = generated.relatedResources || '';
            
            // Clear and repopulate sections array
            this.simpleData.sections.splice(0);
            if (generated.sections && generated.sections.length > 0) {
              generated.sections.forEach(section => {
                this.simpleData.sections.push({
                  heading: section.heading || '',
                  content: section.content || ''
                });
              });
            } else {
              // Add default empty sections
              for (let i = 0; i < 3; i++) {
                this.simpleData.sections.push({ heading: '', content: '' });
              }
            }
            
            // Clear and repopulate FAQ array
            this.simpleData.faq.splice(0);
            if (generated.faq && generated.faq.length > 0) {
              generated.faq.forEach(qa => {
                this.simpleData.faq.push({
                  question: qa.question || '',
                  answer: qa.answer || ''
                });
              });
            } else {
              // Add default empty FAQs
              for (let i = 0; i < 3; i++) {
                this.simpleData.faq.push({ question: '', answer: '' });
              }
            }
            
            // Update page type
            this.currentPage.page_type = this.aiPrompt.contentType || 'blog';
            
            // Suggest path from title
            if (generated.title && this.currentPage.path === '/blog/untitled') {
              const slug = generated.title
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
              this.currentPage.path = `/blog/${slug}`;
            }
            
            console.log('[generateAndApply] Form updated:', {
              title: this.simpleData.title,
              thesis: this.simpleData.thesis,
              answerBoxLength: this.simpleData.answerBox.length,
              keyFactsLength: this.simpleData.keyFacts.length,
              sectionsCount: this.simpleData.sections.length,
              faqCount: this.simpleData.faq.length
            });
            
            const summary = `Generated content:\n\nTitle: ${this.simpleData.title}\nSections: ${this.simpleData.sections.length}\nFAQs: ${this.simpleData.faq.length}\n\nCheck the form below!`;
            console.log(summary);
            alert(summary);
            
            // Scroll to show the filled form
            setTimeout(() => {
              window.scrollTo({ top: 300, behavior: 'smooth' });
            }, 100);
            
          } catch (err) {
            console.error('Generate error:', err);
            alert('Error generating content: ' + err.message + '\n\nMake sure OPENAI_API_KEY is configured on the server.');
          } finally {
            this.generating = false;
          }
        },
        async extractFactsAI() {
          if (!this.currentPage.id) {
            alert('Save the page first before extracting facts.');
            return;
          }

          this.extracting = true;
          this.extractedFactsCount = 0;

          try {
            const res = await fetch(`/studio/pages/${this.currentPage.id}/extract-facts`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({
                thesis: this.simpleData.thesis,
                answerBox: this.simpleData.answerBox
              })
            });

            if (!res.ok) {
              const error = await res.json();
              throw new Error(error.error || 'Failed to extract facts');
            }

            const data = await res.json();
            
            if (data.facts && data.facts.length > 0) {
              // Convert extracted facts to simple line format
              const factLines = data.facts.map(f => 
                `${f.subject} ${f.predicate} ${f.object}`
              );
              
              // Append to existing facts or replace if empty
              if (this.simpleData.keyFacts.trim()) {
                this.simpleData.keyFacts += '\n' + factLines.join('\n');
              } else {
                this.simpleData.keyFacts = factLines.join('\n');
              }
              
              this.extractedFactsCount = data.facts.length;
              alert(`Extracted ${data.facts.length} atomic facts from your narrative.\n\nReview and edit them as needed.`);
            } else {
              alert('No facts were extracted. Try adding more detailed narrative content.');
            }
          } catch (err) {
            console.error('Extract facts error:', err);
            alert('Error extracting facts: ' + err.message + '\n\nMake sure OPENAI_API_KEY is configured on the server.');
          } finally {
            this.extracting = false;
          }
        },
        async generateArtifacts() {
          if (!this.currentPage.id) {
            alert('Save the page first before generating artifacts.');
            return;
          }

          try {
            const res = await fetch(`/studio/pages/${this.currentPage.id}/artifacts`, {
              method: 'POST',
              headers: { 'x-studio-key': this.apiKey }
            });
            if (!res.ok) throw new Error('Failed to generate artifacts');
            
            const artRes = await fetch(`/studio/pages/${this.currentPage.id}/artifacts`, {
              headers: { 'x-studio-key': this.apiKey }
            });
            if (!artRes.ok) throw new Error('Failed to load artifacts');
            
            this.artifacts = await artRes.json();
            this.view = 'artifacts';
          } catch (err) {
            console.error('Generate artifacts error:', err);
            alert('Error generating artifacts: ' + err.message);
          }
        },
        async viewCompliance() {
          if (!this.currentPage.id) {
            alert('Save the page first before checking compliance.');
            return;
          }

          try {
            const res = await fetch(`/studio/pages/${this.currentPage.id}/compliance`, {
              headers: { 'x-studio-key': this.apiKey }
            });
            if (!res.ok) throw new Error('Failed to load compliance');
            
            const data = await res.json();
            this.complianceChecks = data.checks;
            this.view = 'compliance';
          } catch (err) {
            console.error('Compliance error:', err);
            alert('Error loading compliance: ' + err.message);
          }
        },
        // ===== COPY FOR CMS (Phase 1) =====
        async copyForCMS() {
          let html = '<article>\n';
          let plainText = '';
          
          html += `<h1>${this.simpleData.title}</h1>\n`;
          plainText += `${this.simpleData.title}\n\n`;
          
          if (this.simpleData.thesis) {
            html += `<p><strong>${this.simpleData.thesis}</strong></p>\n`;
            plainText += `${this.simpleData.thesis}\n\n`;
          }
          
          if (this.simpleData.answerBox) {
            html += `<h2>Summary</h2>\n<p>${this.simpleData.answerBox}</p>\n`;
            plainText += `Summary\n\n${this.simpleData.answerBox}\n\n`;
          }
          
          this.simpleData.sections.forEach(section => {
            if (section.heading && section.content) {
              html += `<h2>${section.heading}</h2>\n`;
              plainText += `${section.heading}\n\n`;
              
              const paragraphs = section.content.split('\n\n').filter(p => p.trim());
              paragraphs.forEach(p => {
                html += `<p>${p.trim()}</p>\n`;
                plainText += `${p.trim()}\n\n`;
              });
            }
          });
          
          if (this.simpleData.structuredAsset) {
            const isTable = this.simpleData.structuredAsset.includes('|') || this.simpleData.structuredAsset.includes('\t');
            if (isTable) {
              html += this.convertToHTMLTable(this.simpleData.structuredAsset);
            } else {
              html += `<h2>Reference</h2>\n<pre>${this.simpleData.structuredAsset}</pre>\n`;
            }
            plainText += `\n${this.simpleData.structuredAsset}\n\n`;
          }
          
          if (this.simpleData.implications || this.simpleData.nextActions) {
            html += `<h2>What This Means</h2>\n`;
            plainText += `What This Means\n\n`;
            
            if (this.simpleData.implications) {
              html += `<h3>Implications</h3>\n<ul>\n`;
              const implications = this.simpleData.implications.split('\n').filter(l => l.trim());
              implications.forEach(imp => {
                const clean = imp.replace(/^[•\-\*]\s*/, '');
                if (clean) html += `<li>${clean}</li>\n`;
              });
              html += `</ul>\n`;
            }
            
            if (this.simpleData.nextActions) {
              html += `<h3>Next Actions</h3>\n<ul>\n`;
              const actions = this.simpleData.nextActions.split('\n').filter(l => l.trim());
              actions.forEach(action => {
                const clean = action.replace(/^[•\-\*]\s*/, '');
                if (clean) html += `<li>${clean}</li>\n`;
              });
              html += `</ul>\n`;
            }
          }
          
          if (this.simpleData.faq && this.simpleData.faq.some(qa => qa.question)) {
            html += `<h2>Frequently Asked Questions</h2>\n`;
            plainText += `Frequently Asked Questions\n\n`;
            this.simpleData.faq.forEach(qa => {
              if (qa.question && qa.answer) {
                html += `<h3>${qa.question}</h3>\n<p>${qa.answer}</p>\n`;
                plainText += `${qa.question}\n\n${qa.answer}\n\n`;
              }
            });
          }
          
          const payload = {
            hash: this.currentPage.content_hash || 'pending',
            score: this.croutonizerLiveScore,
            artifacts: {
              markdown_url: `https://graph.croutons.ai/v1/artifacts/${this.currentPage.id}/markdown`,
              ndjson_url: `https://graph.croutons.ai/v1/artifacts/${this.currentPage.id}/ndjson`,
              jsonld_url: `https://graph.croutons.ai/v1/artifacts/${this.currentPage.id}/jsonld`
            }
          };
          
          html += `<div hidden data-croutons-payload='${JSON.stringify(payload)}'></div>\n`;
          html += `</article>`;
          
          try {
            const htmlBlob = new Blob([html], { type: 'text/html' });
            const textBlob = new Blob([plainText], { type: 'text/plain' });
            
            await navigator.clipboard.write([
              new ClipboardItem({
                'text/html': htmlBlob,
                'text/plain': textBlob
              })
            ]);
            
            alert(`COPIED FOR CMS!\n\nPaste into WordPress, Shopify, Webflow, or any CMS.\n\nFormatting will be perfect - headings, lists, tables, everything.`);
          } catch (err) {
            console.error('Copy failed:', err);
            await navigator.clipboard.writeText(html);
            alert(`Copied! (HTML format - paste into CMS visual editor)`);
          }
        },
        convertToHTMLTable(text) {
          const lines = text.trim().split('\n').filter(l => l.trim());
          if (lines.length < 2) return `<pre>${text}</pre>\n`;
          
          let html = '<table>\n<thead>\n<tr>';
          const headers = lines[0].split(/\||	/).map(h => h.trim()).filter(h => h);
          headers.forEach(header => { html += `<th>${header}</th>`; });
          html += '</tr>\n</thead>\n<tbody>\n';
          
          const dataRows = lines.slice(1).filter(l => !l.match(/^[\|\-\s]+$/));
          dataRows.forEach(row => {
            const cells = row.split(/\||	/).map(c => c.trim()).filter(c => c);
            html += '<tr>';
            cells.forEach(cell => { html += `<td>${cell}</td>`; });
            html += '</tr>\n';
          });
          
          html += '</tbody>\n</table>\n';
          return html;
        },
        copyTablesTSV() {
          if (!this.simpleData.structuredAsset) return;
          
          const lines = this.simpleData.structuredAsset.trim().split('\n');
          const tsv = lines.map(line => {
            return line.split(/\||	/).map(c => c.trim()).filter(c => c && c !== '-').join('\t');
          }).filter(l => l).join('\n');
          
          navigator.clipboard.writeText(tsv).then(() => {
            alert(`TABLES COPIED AS TSV!\n\nPaste into Excel, Google Sheets, or CMS.\nColumns separated by tabs.`);
          });
        },
        copyConnectorScript() {
          const script = `<!-- Croutons Universal Connector - Add once to site <head> -->
<script>
(function() {
  const payload = document.querySelector('[data-croutons-payload]');
  if (!payload) return;
  
  try {
    const data = JSON.parse(payload.getAttribute('data-croutons-payload'));
    
    fetch(data.artifacts.jsonld_url)
      .then(r => r.json())
      .then(jsonld => {
        const script = document.createElement('script');
        script.type = 'application/ld+json';
        script.textContent = JSON.stringify(jsonld);
        document.head.appendChild(script);
      });
    
    const link = document.createElement('link');
    link.rel = 'alternate';
    link.type = 'text/markdown';
    link.href = data.artifacts.markdown_url;
    document.head.appendChild(link);
    
    const hashMeta = document.createElement('meta');
    hashMeta.name = 'croutons-hash';
    hashMeta.content = data.hash;
    document.head.appendChild(hashMeta);
    
    const scoreMeta = document.createElement('meta');
    scoreMeta.name = 'croutons-score';
    scoreMeta.content = data.score;
    document.head.appendChild(scoreMeta);
    
    console.log('[Croutons] LLM-ready layers injected. Score:', data.score);
  } catch (err) {
    console.error('[Croutons] Failed to inject layers:', err);
  }
})();
<\/script>`;
          
          navigator.clipboard.writeText(script).then(() => {
            alert(`CONNECTOR SCRIPT COPIED!\n\nAdd this ONCE to your site <head>.\n\nIt auto-injects LLM-ready layers for all pasted Croutons articles.`);
          });
        },
        // ===== END COPY METHODS =====
        
        downloadArtifact(key) {
          const content = this.artifacts[key];
          const filename = `${this.currentPage.path.split('/').pop()}.${key === 'markdown' ? 'md' : key === 'ndjson' ? 'ndjson' : key === 'json_ld' ? 'json' : 'html'}`;
          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
