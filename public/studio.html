<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <title>Page Compliance Studio | Croutons</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    [v-cloak] { display: none; }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #F8F8F8;
    }
    code, .font-mono { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
    }
    button { border-radius: 0 !important; font-weight: 500; transition: all 0.15s ease; }
    button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input, select, textarea { border-radius: 0 !important; }
    .check-pass { color: #10B981; }
    .check-fail { color: #EF4444; }
    .check-pending { color: #F59E0B; }
    .word-count { font-size: 0.75rem; color: #6B6B6B; }
    .section-card { transition: all 0.2s; }
    .section-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  <div id="app" v-cloak>
    <!-- Header -->
    <section class="w-full bg-white py-8 px-4 md:px-8 border-b-2 border-[#0A0A0A]">
      <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-3xl font-bold text-[#0A0A0A]">Page Compliance Studio</h1>
            <p class="text-sm text-[#6B6B6B] mt-1">AEO/GEO Content Production ‚Ä¢ Croutons Protocol A-J</p>
          </div>
          <div class="flex gap-3">
            <button @click="view='list'" 
                    :class="view==='list' ? 'bg-[#0A0A0A] text-white' : 'bg-white text-[#0A0A0A] border-2 border-[#0A0A0A]'"
                    class="px-6 py-2 font-medium uppercase tracking-wide text-sm">
              My Pages
            </button>
            <button @click="startNewPage" 
                    class="px-6 py-2 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF] font-medium uppercase tracking-wide text-sm">
              + New Page
            </button>
          </div>
        </div>
        
        <!-- Mode Toggle -->
        <div v-if="view==='editor'" class="flex items-center gap-2 text-xs">
          <span class="text-[#6B6B6B]">Mode:</span>
          <button @click="editorMode='simple'" 
                  :class="editorMode==='simple' ? 'bg-[#0A0A0A] text-white' : 'bg-[#E5E5E5] text-[#0A0A0A]'"
                  class="px-3 py-1">
            Simple (Writers)
          </button>
          <button @click="editorMode='advanced'" 
                  :class="editorMode==='advanced' ? 'bg-[#0A0A0A] text-white' : 'bg-[#E5E5E5] text-[#0A0A0A]'"
                  class="px-3 py-1">
            Advanced (Developers)
          </button>
        </div>
      </div>
    </section>

    <!-- API Key Gate -->
    <div v-if="!apiKey" class="max-w-2xl mx-auto mt-12 px-4">
      <div class="bg-white border-2 border-[#0A0A0A] p-8">
        <h2 class="text-2xl font-bold mb-4">Studio Access Required</h2>
        <p class="text-[#6B6B6B] mb-6">Enter your Studio API key to access Page Compliance Studio. Contact your team lead for access.</p>
        <input v-model="apiKeyInput" 
               type="password" 
               placeholder="Paste API key here"
               class="w-full border-2 border-[#0A0A0A] px-4 py-3 mb-4 font-mono text-sm"
               @keyup.enter="setApiKey">
        <button @click="setApiKey" 
                class="w-full bg-[#0A0A0A] text-white px-6 py-3 font-medium uppercase tracking-wide">
          Access Studio
        </button>
      </div>
    </div>

    <!-- Page List -->
    <div v-if="apiKey && view==='list'" class="max-w-7xl mx-auto mt-8 px-4">
      <div v-if="loading" class="text-center py-12 text-[#6B6B6B]">Loading pages...</div>
      
      <div v-else-if="pages.length === 0" class="text-center py-12">
        <p class="text-[#6B6B6B] mb-6">No pages yet. Create your first AEO/GEO-compliant page.</p>
        <button @click="startNewPage" 
                class="px-8 py-3 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF] font-medium uppercase tracking-wide">
          + Create First Page
        </button>
      </div>
      
      <div v-else class="grid gap-4">
        <div v-for="page in pages" :key="page.id" 
             @click="editPage(page.id)"
             class="bg-white border-2 border-[#0A0A0A] p-6 cursor-pointer section-card">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <h3 class="text-lg font-bold text-[#0A0A0A] mb-1">{{ page.domain }}{{ page.path }}</h3>
              <p class="text-sm text-[#6B6B6B] capitalize">{{ page.page_type.replace('_', ' ') }}</p>
            </div>
            <span class="px-3 py-1 bg-[#E5E5E5] text-[#0A0A0A] text-xs font-mono">
              ID: {{ page.id }}
            </span>
          </div>
          <div class="flex items-center gap-4 text-xs text-[#6B6B6B]">
            <span>Updated {{ new Date(page.updated_at).toLocaleDateString() }}</span>
            <span>‚Ä¢</span>
            <span class="font-mono">{{ page.content_hash?.substring(0, 12) || 'No hash' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Editor View -->
    <div v-if="apiKey && view==='editor'" class="max-w-7xl mx-auto mt-8 px-4 pb-12">
      
      <!-- Simple Mode (Content Writers) -->
      <div v-if="editorMode==='simple'" class="space-y-6">
        
        <!-- Page Info -->
        <div class="bg-white border-2 border-[#0A0A0A] p-6">
          <h2 class="text-xl font-bold mb-4">Page Details</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Content Type</label>
              <select v-model="currentPage.page_type" class="w-full border-2 border-[#0A0A0A] px-4 py-2">
                <option value="blog">Blog Post / Article</option>
                <option value="landing">Landing Page</option>
                <option value="product">Product Page</option>
                <option value="product_marketing">Product Marketing</option>
                <option value="faq">FAQ / Help</option>
                <option value="home">Homepage</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">URL Path</label>
              <input v-model="currentPage.path" 
                     placeholder="/blog/my-article"
                     class="w-full border-2 border-[#0A0A0A] px-4 py-2">
            </div>
          </div>
        </div>

        <!-- LLM READINESS SCORE -->
        <div class="bg-gradient-to-r from-[#00C2FF] to-[#0A0A0A] text-white p-8 rounded-lg text-center mb-6">
          <div class="text-sm font-bold uppercase tracking-wider mb-2">LLM Readiness Score</div>
          <div class="text-6xl font-bold mb-2">{{ Math.round((checklistScore / 12) * 100) }}%</div>
          <div class="text-sm opacity-90">
            {{ Math.round((checklistScore / 12) * 100) >= 80 ? '‚úÖ Excellent - Ready for AI Citations!' : 
               Math.round((checklistScore / 12) * 100) >= 65 ? '‚úì Good - Minor improvements needed' : 
               '‚ö†Ô∏è Needs work - Complete more checklist items' }}
          </div>
          <div class="mt-4 pt-4 border-t border-white/20 flex justify-around text-xs">
            <div>
              <div class="font-bold text-2xl">{{ keyFactsCount }}</div>
              <div class="opacity-75">Facts</div>
            </div>
            <div>
              <div class="font-bold text-2xl">{{ answerBoxWordCount }}</div>
              <div class="opacity-75">Answer Box Words</div>
            </div>
            <div>
              <div class="font-bold text-2xl">{{ simpleData.sections.length }}</div>
              <div class="opacity-75">Sections</div>
            </div>
          </div>
        </div>

        <!-- AEO/GEO Checklist -->
        <div class="bg-white border-2 border-[#0A0A0A] p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">Writer Checklist</h2>
            <div class="text-sm">
              <span :class="checklistScore >= 8 ? 'check-pass' : 'check-fail'" class="font-bold">
                {{ checklistScore }}/12 Complete
              </span>
            </div>
          </div>

          <!-- 1. Title + Thesis -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="simpleData.title.length > 5 ? 'check-pass' : 'check-fail'">
                {{ simpleData.title.length > 5 ? '‚úì' : '‚óã' }}
              </span>
              <h3 class="font-bold">1. Title + One-Line Thesis</h3>
            </div>
            <input v-model="simpleData.title" 
                   placeholder="Title: Specific outcome/mechanism, not generic"
                   class="w-full border-2 border-[#0A0A0A] px-4 py-3 mb-3">
            <textarea v-model="simpleData.thesis" 
                      placeholder="One declarative sentence stating the main claim"
                      rows="2"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3"></textarea>
          </div>

          <!-- 2. Answer Box -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="answerBoxValid ? 'check-pass' : 'check-fail'">
                {{ answerBoxValid ? '‚úì' : '‚óã' }}
              </span>
              <h3 class="font-bold">2. Answer Box (40-60 words)</h3>
              <span class="word-count ml-auto">{{ answerBoxWordCount }} words</span>
            </div>
            <p class="text-xs text-[#6B6B6B] mb-3">
              AI-quotable snippet: (1) Situation/context, (2) Key claim, (3) Mechanism/why
            </p>
            <textarea v-model="simpleData.answerBox" 
                      placeholder="Write a 40-60 word snippet that stands alone. No warm-up phrases."
                      rows="4"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3"></textarea>
          </div>

          <!-- 3. Key Facts -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="keyFactsValid ? 'check-pass' : 'check-fail'">
                {{ keyFactsValid ? '‚úì' : '‚óã' }}
              </span>
              <h3 class="font-bold">3. Key Facts (8-15 atomic lines)</h3>
              <span class="word-count ml-auto">{{ keyFactsCount }} facts</span>
            </div>
            <p class="text-xs text-[#6B6B6B] mb-3">
              One fact per line. No pronouns. Format: "X is Y" / "X causes Y by Z" / "X requires Y when Z"
            </p>
            
            <!-- AI Extract Button -->
            <div class="mb-3 flex gap-2">
              <button @click="extractFactsAI" 
                      :disabled="extracting || !currentPage.id"
                      class="px-4 py-2 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF] font-medium text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                {{ extracting ? 'ü§ñ Extracting Facts...' : 'ü§ñ Extract Facts from Narrative' }}
              </button>
              <span v-if="extractedFactsCount > 0" class="text-xs text-[#25D366] self-center">
                ‚úì {{ extractedFactsCount }} facts extracted
              </span>
            </div>
            
            <textarea v-model="simpleData.keyFacts" 
                      placeholder="Entity X defines a stable identifier for disambiguation.&#10;Comparison tables require at least three columns to preserve context.&#10;Evidence-based identity reduces ambiguity in entity matching by 40%."
                      rows="10"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 font-mono text-sm"></textarea>
          </div>

          <!-- 4. H2 Sections -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="sectionsValid ? 'check-pass' : 'check-fail'">
                {{ sectionsValid ? '‚úì' : '‚óã' }}
              </span>
              <h3 class="font-bold">4. Main Sections (3-6 H2s)</h3>
              <span class="word-count ml-auto">{{ simpleData.sections.length }} sections</span>
            </div>
            <p class="text-xs text-[#6B6B6B] mb-3">
              Each section: definition/constraint + information gain (number/rule/comparison/checklist)
            </p>
            <div v-for="(section, i) in simpleData.sections" :key="i" class="mb-3 bg-[#F8F8F8] p-4">
              <input v-model="section.heading" 
                     :placeholder="'H2 #' + (i+1) + ': Entity/Mechanism/Question'"
                     class="w-full border-2 border-[#0A0A0A] px-3 py-2 mb-2">
              <textarea v-model="section.content" 
                        placeholder="Definition/constraint + one information-gain item (number/rule/comparison)"
                        rows="3"
                        class="w-full border-2 border-[#0A0A0A] px-3 py-2 text-sm"></textarea>
              <button @click="simpleData.sections.splice(i, 1)" 
                      class="mt-2 px-3 py-1 bg-[#E5E5E5] text-[#0A0A0A] text-xs">
                Remove Section
              </button>
            </div>
            <button @click="simpleData.sections.push({heading: '', content: ''})" 
                    class="w-full px-4 py-2 bg-[#E5E5E5] text-[#0A0A0A] border-2 border-[#0A0A0A]">
              + Add Section
            </button>
          </div>

          <!-- 5. Structured Asset -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="simpleData.structuredAsset.length > 20 ? 'check-pass' : 'check-fail'">
                {{ simpleData.structuredAsset.length > 20 ? '‚úì' : '‚óã' }}
              </span>
              <h3 class="font-bold">5. Structured Asset (required)</h3>
            </div>
            <p class="text-xs text-[#6B6B6B] mb-3">
              Choose ONE: Table (3+ cols) / Technical list / Decision rubric / Field spec
            </p>
            <textarea v-model="simpleData.structuredAsset" 
                      placeholder="Paste your table, list, rubric, or spec here (markdown/CSV/plain text)"
                      rows="8"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 font-mono text-sm"></textarea>
          </div>

          <!-- 6. What This Means -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="simpleData.implications.length > 10 && simpleData.nextActions.length > 10 ? 'check-pass' : 'check-fail'">
                {{ simpleData.implications.length > 10 && simpleData.nextActions.length > 10 ? '‚úì' : '‚óã' }}
              </span>
              <h3 class="font-bold">6. What This Means (actionable closure)</h3>
            </div>
            <label class="block text-sm font-medium mb-2">Implications (3-5 bullets):</label>
            <textarea v-model="simpleData.implications" 
                      placeholder="‚Ä¢ Implication 1: what changes&#10;‚Ä¢ Implication 2: what to watch&#10;‚Ä¢ Implication 3: what becomes possible"
                      rows="4"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 mb-3 text-sm"></textarea>
            
            <label class="block text-sm font-medium mb-2">Next Actions (3-5 bullets):</label>
            <textarea v-model="simpleData.nextActions" 
                      placeholder="‚Ä¢ Action 1: concrete step&#10;‚Ä¢ Action 2: concrete step&#10;‚Ä¢ Action 3: concrete step"
                      rows="4"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 mb-3 text-sm"></textarea>
            
            <label class="block text-sm font-medium mb-2">First 30 Minutes:</label>
            <input v-model="simpleData.first30Min" 
                   placeholder="One immediate action a reader can execute quickly"
                   class="w-full border-2 border-[#0A0A0A] px-4 py-2 text-sm">
          </div>

          <!-- 7. Related Resources -->
          <div class="mb-6 pb-6 border-b-2 border-[#E5E5E5]">
            <div class="flex items-center gap-2 mb-3">
              <span :class="simpleData.relatedResources.length > 10 ? 'check-pass' : 'check-fail'">
                {{ simpleData.relatedResources.length > 10 ? '‚úì' : '‚óã' }}
              </span>
              <h3 class="font-bold">7. Related Resources (internal links)</h3>
            </div>
            <textarea v-model="simpleData.relatedResources" 
                      placeholder="Parent pillar: [slug or title]&#10;Related page: [slug or title]&#10;Related page: [slug or title]"
                      rows="4"
                      class="w-full border-2 border-[#0A0A0A] px-4 py-3 text-sm"></textarea>
          </div>

          <!-- 8. FAQ -->
          <div class="mb-6">
            <div class="flex items-center gap-2 mb-3">
              <span :class="faqValid ? 'check-pass' : 'check-fail'">
                {{ faqValid ? '‚úì' : '‚óã' }}
              </span>
              <h3 class="font-bold">8. FAQ (3-5 Q&As, <50 words each)</h3>
              <span class="word-count ml-auto">{{ simpleData.faq.length }} Q&As</span>
            </div>
            <div v-for="(qa, i) in simpleData.faq" :key="i" class="mb-4 bg-[#F8F8F8] p-4">
              <input v-model="qa.question" 
                     :placeholder="'Question ' + (i+1)"
                     class="w-full border-2 border-[#0A0A0A] px-3 py-2 mb-2">
              <textarea v-model="qa.answer" 
                        placeholder="Short answer (<50 words): definition / yes-no + condition / number + scope / step"
                        rows="3"
                        class="w-full border-2 border-[#0A0A0A] px-3 py-2 text-sm mb-2"></textarea>
              <div class="flex items-center justify-between">
                <span class="text-xs" :class="qa.answer.split(' ').length <= 50 ? 'check-pass' : 'check-fail'">
                  {{ qa.answer.split(' ').filter(w => w).length }} words
                </span>
                <button @click="simpleData.faq.splice(i, 1)" 
                        class="px-3 py-1 bg-[#E5E5E5] text-[#0A0A0A] text-xs">
                  Remove
                </button>
              </div>
            </div>
            <button @click="simpleData.faq.push({question: '', answer: ''})" 
                    class="w-full px-4 py-2 bg-[#E5E5E5] text-[#0A0A0A] border-2 border-[#0A0A0A]">
              + Add Q&A
            </button>
          </div>
        </div>

        <!-- Actions -->
        <div class="space-y-4">
          <div class="flex gap-4">
            <button @click="saveSimplePage" 
                    :disabled="saving || checklistScore < 8"
                    class="flex-1 px-8 py-4 bg-[#0A0A0A] text-white font-medium uppercase tracking-wide disabled:opacity-50">
              {{ saving ? 'Saving...' : 'üíæ Save Content' }}
            </button>
            <button @click="viewCompliance" 
                    :disabled="!currentPage.id"
                    class="flex-1 px-8 py-4 bg-[#25D366] text-white font-medium uppercase tracking-wide disabled:opacity-50">
              ‚úÖ Check Compliance Score
            </button>
          </div>
          
          <div class="bg-[#F8F8F8] border-2 border-[#E5E5E5] p-4 text-center">
            <div class="text-sm text-[#6B6B6B] mb-2">
              <strong>For Developers Only:</strong> Need technical files (markdown, JSON-LD, NDJSON)?
            </div>
            <button @click="editorMode='advanced'" 
                    class="px-6 py-2 bg-white text-[#0A0A0A] border-2 border-[#0A0A0A] font-medium text-sm hover:bg-[#0A0A0A] hover:text-white">
              ‚Üí Switch to Developer Mode
            </button>
          </div>
        </div>

        <div v-if="checklistScore < 8" class="bg-[#FEF3C7] border-2 border-[#F59E0B] p-4 text-sm">
          <strong>‚ö† Complete More Items:</strong> Fill in at least 8/12 checklist items to save your content.
        </div>
      </div>

      <!-- Advanced Mode (Developers) -->
      <div v-if="editorMode==='advanced'" class="bg-white border-2 border-[#0A0A0A] p-6">
        <h2 class="text-xl font-bold mb-4">Advanced Mode (Developer View)</h2>
        <p class="text-sm text-[#6B6B6B] mb-6">
          Direct access to facts, sections, and protocol internals. For technical users only.
        </p>
        <div class="bg-[#F8F8F8] p-4 rounded font-mono text-sm">
          <pre>{{ JSON.stringify(currentPage, null, 2) }}</pre>
        </div>
        <button @click="editorMode='simple'" 
                class="mt-4 px-6 py-2 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF]">
          ‚Üê Back to Simple Mode
        </button>
      </div>
    </div>

    <!-- Artifacts View -->
    <div v-if="apiKey && view==='artifacts'" class="max-w-7xl mx-auto mt-8 px-4 pb-12">
      <div class="bg-white border-2 border-[#0A0A0A] p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Generated Artifacts</h2>
          <button @click="view='editor'" 
                  class="px-4 py-2 bg-[#E5E5E5] text-[#0A0A0A]">
            ‚Üê Back to Editor
          </button>
        </div>
        <p class="text-sm text-[#6B6B6B]">
          Download these files and add them to your page deployment.
        </p>
      </div>

      <div v-for="(artifact, key) in artifacts" :key="key" class="bg-white border-2 border-[#0A0A0A] p-6 mb-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-lg capitalize">{{ key.replace('_', ' ') }}</h3>
          <button @click="downloadArtifact(key)" 
                  class="px-4 py-2 bg-[#00C2FF] text-[#0A0A0A] border-2 border-[#00C2FF]">
            Download
          </button>
        </div>
        <pre class="bg-[#F8F8F8] p-4 overflow-x-auto text-xs font-mono border-2 border-[#E5E5E5]">{{ artifact }}</pre>
      </div>
    </div>

    <!-- Compliance View -->
    <div v-if="apiKey && view==='compliance'" class="max-w-5xl mx-auto mt-8 px-4 pb-12">
      <div class="bg-white border-2 border-[#0A0A0A] p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Protocol Compliance (A-J)</h2>
          <button @click="view='editor'" 
                  class="px-4 py-2 bg-[#E5E5E5] text-[#0A0A0A]">
            ‚Üê Back to Editor
          </button>
        </div>
        <div class="text-3xl font-bold" :class="complianceScore >= 8 ? 'check-pass' : 'check-fail'">
          {{ complianceScore }}/10 Checks Passing
        </div>
      </div>

      <div class="space-y-3">
        <div v-for="check in complianceChecks" :key="check.id" 
             class="bg-white border-2 border-[#0A0A0A] p-6">
          <div class="flex items-start gap-4">
            <span class="text-2xl" :class="check.status === 'pass' ? 'check-pass' : check.status === 'fail' ? 'check-fail' : 'check-pending'">
              {{ check.status === 'pass' ? '‚úì' : check.status === 'fail' ? '‚úó' : '‚óã' }}
            </span>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-1">{{ check.id.toUpperCase() }} - {{ check.title }}</h3>
              <p class="text-sm text-[#6B6B6B] mb-2">{{ check.description }}</p>
              <p class="text-sm" :class="check.status === 'pass' ? 'check-pass' : check.status === 'fail' ? 'check-fail' : 'check-pending'">
                {{ check.message }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          apiKey: '',
          apiKeyInput: '',
          view: 'list', // list, editor, artifacts, compliance
          editorMode: 'simple', // simple, advanced
          loading: false,
          saving: false,
          extracting: false,
          extractedFactsCount: 0,
          pages: [],
          currentPage: { domain: 'croutons.ai', path: '', page_type: 'blog' },
          simpleData: {
            title: '',
            thesis: '',
            answerBox: '',
            keyFacts: '',
            sections: [],
            structuredAsset: '',
            implications: '',
            nextActions: '',
            first30Min: '',
            relatedResources: '',
            faq: []
          },
          artifacts: {},
          complianceChecks: []
        };
      },
      computed: {
        answerBoxWordCount() {
          return this.simpleData.answerBox.split(' ').filter(w => w).length;
        },
        answerBoxValid() {
          const wc = this.answerBoxWordCount;
          return wc >= 40 && wc <= 60;
        },
        keyFactsCount() {
          return this.simpleData.keyFacts.split('\n').filter(l => l.trim()).length;
        },
        keyFactsValid() {
          const count = this.keyFactsCount;
          return count >= 8 && count <= 15;
        },
        sectionsValid() {
          const count = this.simpleData.sections.filter(s => s.heading && s.content).length;
          return count >= 3 && count <= 6;
        },
        faqValid() {
          const count = this.simpleData.faq.filter(qa => qa.question && qa.answer).length;
          return count >= 3 && count <= 5;
        },
        checklistScore() {
          let score = 0;
          if (this.simpleData.title.length > 5) score++;
          if (this.simpleData.thesis.length > 10) score++;
          if (this.answerBoxValid) score++;
          if (this.keyFactsValid) score++;
          if (this.sectionsValid) score++;
          if (this.simpleData.structuredAsset.length > 20) score++;
          if (this.simpleData.implications.length > 10 && this.simpleData.nextActions.length > 10) score++;
          if (this.simpleData.first30Min.length > 5) score++;
          if (this.simpleData.relatedResources.length > 10) score++;
          if (this.faqValid) score++;
          // Terminology + red-flag check (manual, assume pass if >8)
          if (score >= 8) score += 2;
          return score;
        },
        complianceScore() {
          return this.complianceChecks.filter(c => c.status === 'pass').length;
        }
      },
      methods: {
        setApiKey() {
          if (this.apiKeyInput) {
            this.apiKey = this.apiKeyInput;
            localStorage.setItem('studio_api_key', this.apiKey);
            this.loadPages();
          }
        },
        async loadPages() {
          this.loading = true;
          try {
            const res = await fetch('/studio/pages', {
              headers: { 'x-studio-key': this.apiKey }
            });
            if (res.ok) {
              this.pages = await res.json();
            }
          } catch (err) {
            console.error('Load pages error:', err);
          }
          this.loading = false;
        },
        startNewPage() {
          this.currentPage = { 
            domain: 'croutons.ai', 
            path: '/blog/untitled', 
            page_type: 'blog' 
          };
          this.simpleData = {
            title: '',
            thesis: '',
            answerBox: '',
            keyFacts: '',
            sections: [
              { heading: '', content: '' },
              { heading: '', content: '' },
              { heading: '', content: '' }
            ],
            structuredAsset: '',
            implications: '',
            nextActions: '',
            first30Min: '',
            relatedResources: '',
            faq: [
              { question: '', answer: '' },
              { question: '', answer: '' },
              { question: '', answer: '' }
            ]
          };
          this.view = 'editor';
          this.editorMode = 'simple';
        },
        async editPage(id) {
          this.loading = true;
          try {
            const res = await fetch(`/studio/pages/${id}`, {
              headers: { 'x-studio-key': this.apiKey }
            });
            if (res.ok) {
              const data = await res.json();
              this.currentPage = data.page;
              // TODO: Parse technical data back into simple format
              this.view = 'editor';
            }
          } catch (err) {
            console.error('Edit page error:', err);
          }
          this.loading = false;
        },
        async saveSimplePage() {
          if (this.checklistScore < 8) {
            alert('Complete at least 8/12 checklist items before saving.');
            return;
          }

          this.saving = true;
          try {
            // Convert simple data to technical format
            const sections = this.simpleData.sections
              .filter(s => s.heading && s.content)
              .map((s, i) => ({
                anchor: s.heading.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
                heading: s.heading,
                description: s.content.substring(0, 200)
              }));

            const facts = this.simpleData.keyFacts
              .split('\n')
              .filter(l => l.trim())
              .map(line => {
                // Parse "X is Y" / "X does Y" format
                const parts = line.split(/\s+(is|are|has|does|causes|requires|includes)\s+/i);
                return {
                  subject: parts[0] || 'Unknown',
                  predicate: parts[1] || 'related_to',
                  object: parts[2] || line,
                  schema_type: 'Thing',
                  fact_category: 'content'
                };
              });

            // Create or update page
            const method = this.currentPage.id ? 'PUT' : 'POST';
            const url = this.currentPage.id 
              ? `/studio/pages/${this.currentPage.id}` 
              : '/studio/pages';

            const pageRes = await fetch(url, {
              method,
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({
                domain: this.currentPage.domain,
                path: this.currentPage.path,
                page_type: this.currentPage.page_type
              })
            });

            if (!pageRes.ok) throw new Error('Failed to save page');
            const pageData = await pageRes.json();
            this.currentPage.id = pageData.id;

            // Save sections
            await fetch(`/studio/pages/${this.currentPage.id}/sections`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({ sections })
            });

            // Save facts
            await fetch(`/studio/pages/${this.currentPage.id}/facts`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({ facts })
            });

            alert('‚úì Page saved successfully!');
            this.loadPages();
          } catch (err) {
            console.error('Save error:', err);
            alert('Error saving page: ' + err.message);
          }
          this.saving = false;
        },
        async extractFactsAI() {
          if (!this.currentPage.id) {
            alert('Save the page first before extracting facts.');
            return;
          }

          this.extracting = true;
          this.extractedFactsCount = 0;

          try {
            const res = await fetch(`/studio/pages/${this.currentPage.id}/extract-facts`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-studio-key': this.apiKey
              },
              body: JSON.stringify({
                thesis: this.simpleData.thesis,
                answerBox: this.simpleData.answerBox
              })
            });

            if (!res.ok) {
              const error = await res.json();
              throw new Error(error.error || 'Failed to extract facts');
            }

            const data = await res.json();
            
            if (data.facts && data.facts.length > 0) {
              // Convert extracted facts to simple line format
              const factLines = data.facts.map(f => 
                `${f.subject} ${f.predicate} ${f.object}`
              );
              
              // Append to existing facts or replace if empty
              if (this.simpleData.keyFacts.trim()) {
                this.simpleData.keyFacts += '\n' + factLines.join('\n');
              } else {
                this.simpleData.keyFacts = factLines.join('\n');
              }
              
              this.extractedFactsCount = data.facts.length;
              alert(`‚úì Extracted ${data.facts.length} atomic facts from your narrative!\n\nReview and edit them as needed.`);
            } else {
              alert('No facts were extracted. Try adding more detailed narrative content.');
            }
          } catch (err) {
            console.error('Extract facts error:', err);
            alert('Error extracting facts: ' + err.message + '\n\nMake sure OPENAI_API_KEY is configured on the server.');
          } finally {
            this.extracting = false;
          }
        },
        async generateArtifacts() {
          if (!this.currentPage.id) {
            alert('Save the page first before generating artifacts.');
            return;
          }

          try {
            const res = await fetch(`/studio/pages/${this.currentPage.id}/artifacts`, {
              method: 'POST',
              headers: { 'x-studio-key': this.apiKey }
            });
            if (!res.ok) throw new Error('Failed to generate artifacts');
            
            const artRes = await fetch(`/studio/pages/${this.currentPage.id}/artifacts`, {
              headers: { 'x-studio-key': this.apiKey }
            });
            if (!artRes.ok) throw new Error('Failed to load artifacts');
            
            this.artifacts = await artRes.json();
            this.view = 'artifacts';
          } catch (err) {
            console.error('Generate artifacts error:', err);
            alert('Error generating artifacts: ' + err.message);
          }
        },
        async viewCompliance() {
          if (!this.currentPage.id) {
            alert('Save the page first before checking compliance.');
            return;
          }

          try {
            const res = await fetch(`/studio/pages/${this.currentPage.id}/compliance`, {
              headers: { 'x-studio-key': this.apiKey }
            });
            if (!res.ok) throw new Error('Failed to load compliance');
            
            const data = await res.json();
            this.complianceChecks = data.checks;
            this.view = 'compliance';
          } catch (err) {
            console.error('Compliance error:', err);
            alert('Error loading compliance: ' + err.message);
          }
        },
        downloadArtifact(key) {
          const content = this.artifacts[key];
          const filename = `${this.currentPage.path.split('/').pop()}.${key === 'markdown' ? 'md' : key === 'ndjson' ? 'ndjson' : key === 'json_ld' ? 'json' : 'html'}`;
          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        }
      },
      mounted() {
        const saved = localStorage.getItem('studio_api_key');
        if (saved) {
          this.apiKey = saved;
          this.loadPages();
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
