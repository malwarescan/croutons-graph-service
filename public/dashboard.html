<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Croutons Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <meta name="format-detection" content="telephone=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    /* Mobile optimizations */
    @media (max-width: 768px) {
      button, .btn, a[role="button"] { 
        min-height: 44px; 
        min-width: 44px; 
        touch-action: manipulation; 
        padding: 10px 16px;
      }
      table { font-size: 12px; min-width: 600px; }
      th, td { padding: 10px 8px; white-space: nowrap; }
      section { padding-left: 1rem; padding-right: 1rem; }
      h1 { font-size: 1.75rem !important; }
      h2 { font-size: 1.25rem !important; }
    }
    @media (max-width: 640px) {
      .grid { gap: 1rem !important; }
      .border-2 { border-width: 1px; }
    }
    @media (max-width: 480px) {
      body { font-size: 14px; }
      .text-sm { font-size: 12px; }
      .text-xs { font-size: 11px; }
      table { font-size: 11px; min-width: 500px; }
      th, td { padding: 8px 6px; }
    }
  </style>
</head>
<body class="bg-[#F8F8F8] min-h-screen">
  <section class="w-full bg-white py-12 md:py-24 px-4 md:px-8">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8 md:mb-16">
        <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold text-[#0A0A0A] mb-4">
          Croutons Dashboard
        </h1>
        <p class="text-sm md:text-lg text-[#6B6B6B] max-w-2xl mx-auto px-4">
          Monitor verified domains, content generation, and ingestion status.
        </p>
      </div>

      <!-- Live Stats -->
      <div class="border-2 border-[#0A0A0A] p-4 md:p-8 mb-6 md:mb-8">
        <h2 class="text-xl md:text-2xl font-bold text-[#0A0A0A] mb-4 md:mb-6">Live Stats</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <div class="flex flex-col">
            <div id="kpiCroutons" class="text-3xl md:text-4xl font-bold text-[#25D366]">0</div>
            <div class="text-xs md:text-sm text-[#6B6B6B] font-mono mt-1">Croutons</div>
          </div>
          <div class="flex flex-col">
            <div id="kpiTriples" class="text-3xl md:text-4xl font-bold text-[#25D366]">0</div>
            <div class="text-xs md:text-sm text-[#6B6B6B] font-mono mt-1">Triples</div>
          </div>
          <div class="col-span-2 md:col-span-1 flex flex-col justify-center">
            <div class="text-xs md:text-sm text-[#6B6B6B] font-mono mb-2">Updated: <span id="statsTime">never</span></div>
            <button id="btnRefreshStats" class="w-full px-6 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer touch-manipulation">Refresh</button>
          </div>
        </div>
      </div>

      <!-- Vue App Root - Tabs -->
      <div id="app">
        <!-- Tab Navigation -->
        <div class="overflow-x-auto -mx-4 md:mx-0 px-4 md:px-0 mb-6 md:mb-8">
          <div class="flex gap-2 border-b-2 border-[#0A0A0A] pb-2 min-w-max md:min-w-0">
            <button 
              @click="tab='verified'" 
              :class="tab==='verified' ? 'font-bold text-[#00C2FF] border-b-2 border-[#00C2FF] pb-2 -mb-[2px] px-4' : 'text-[#6B6B6B] hover:text-[#0A0A0A] px-4 transition-colors duration-200'"
              class="font-mono text-sm uppercase tracking-wider touch-manipulation py-2">
              Verified Domains
            </button>
            <button 
              @click="tab='sources'" 
              :class="tab==='sources' ? 'font-bold text-[#00C2FF] border-b-2 border-[#00C2FF] pb-2 -mb-[2px] px-4' : 'text-[#6B6B6B] hover:text-[#0A0A0A] px-4 transition-colors duration-200'"
              class="font-mono text-sm uppercase tracking-wider touch-manipulation py-2">
              AI-Readable Sources
            </button>
            <button
              @click="tab='urls'"
              :class="tab==='urls' ? 'font-bold text-[#00C2FF] border-b-2 border-[#00C2FF] pb-2 -mb-[2px] px-4' : 'text-[#6B6B6B] hover:text-[#0A0A0A] px-4 transition-colors duration-200'"
              class="font-mono text-sm uppercase tracking-wider touch-manipulation py-2">
              URL Verification
            </button>
          </div>
        </div>

        <!-- Verified Domains Tab -->
        <div v-if="tab==='verified'">
          <div class="border-2 border-[#0A0A0A] p-4 md:p-8">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4 md:mb-6">
              <h2 class="text-xl md:text-2xl font-bold text-[#0A0A0A]">Verified Domains</h2>
              <button @click="loadVerifiedDomains" :disabled="verified.loading" class="w-full sm:w-auto px-6 py-3 md:py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer disabled:bg-[#6B6B6B] disabled:opacity-60 disabled:cursor-not-allowed touch-manipulation">
                {{ verified.loading ? 'Loading...' : 'Refresh' }}
              </button>
            </div>
            <div class="text-xs md:text-sm text-[#6B6B6B] mb-4 md:mb-6">
              DNS-verified domains connected to Croutons. Shows verification status, markdown generation, and health metrics.
            </div>
            
            <!-- Summary Stats -->
            <div v-if="verified.data && verified.data.length > 0" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="border-2 border-[#0A0A0A] p-4 rounded-lg">
                <div class="text-2xl md:text-3xl font-bold text-[#25D366]">{{ verified.data.length }}</div>
                <div class="text-xs text-[#6B6B6B] font-mono mt-1">Total Verified</div>
              </div>
              <div class="border-2 border-[#0A0A0A] p-4 rounded-lg">
                <div class="text-2xl md:text-3xl font-bold text-[#25D366]">{{ verifiedHealthy }}</div>
                <div class="text-xs text-[#6B6B6B] font-mono mt-1">Healthy</div>
              </div>
              <div class="border-2 border-[#0A0A0A] p-4 rounded-lg">
                <div class="text-2xl md:text-3xl font-bold text-[#00C2FF]">{{ totalActiveMarkdown }}</div>
                <div class="text-xs text-[#6B6B6B] font-mono mt-1">Active Markdown</div>
              </div>
              <div class="border-2 border-[#0A0A0A] p-4 rounded-lg">
                <div class="text-2xl md:text-3xl font-bold text-[#00C2FF]">{{ totalCroutons }}</div>
                <div class="text-xs text-[#6B6B6B] font-mono mt-1">Total Croutons</div>
              </div>
            </div>
            
            <!-- Domain Table -->
            <div class="overflow-x-auto border-2 border-[#0A0A0A] rounded-lg -mx-2 md:mx-0">
              <div class="inline-block min-w-full">
                <table class="w-full border-collapse text-xs sm:text-sm min-w-[800px]">
                  <thead>
                    <tr>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Domain</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Status</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Verified</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Markdown</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Pages</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Croutons</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Last Activity</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="verified.loading">
                      <td colspan="7" class="text-[#6B6B6B] p-3 text-center">Loading verified domains...</td>
                    </tr>
                    <tr v-else-if="!verified.data || verified.data.length === 0">
                      <td colspan="7" class="text-[#6B6B6B] p-3 text-center">No verified domains yet</td>
                    </tr>
                    <tr v-else v-for="domain in verified.data" :key="domain.domain" class="hover:bg-[#F8F8F8] transition-colors duration-200">
                      <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-[#0A0A0A] font-bold">
                        <a :href="'https://md.croutons.ai/' + domain.domain + '/index.md'" target="_blank" class="text-[#00C2FF] hover:underline">
                          {{ domain.domain }}
                        </a>
                      </td>
                      <td class="border-b border-[#0A0A0A]/20 p-3">
                        <span :class="{
                          'text-[#25D366]': domain.health_status === 'healthy',
                          'text-[#FF9500]': domain.health_status === 'degraded',
                          'text-[#EF4444]': domain.health_status === 'inactive'
                        }" class="font-mono text-xs px-2 py-1 rounded-full border-2" :style="{
                          borderColor: domain.health_status === 'healthy' ? '#25D366' : domain.health_status === 'degraded' ? '#FF9500' : '#EF4444',
                          backgroundColor: domain.health_status === 'healthy' ? '#25D36610' : domain.health_status === 'degraded' ? '#FF950010' : '#EF444410'
                        }">
                          {{ domain.health_status.toUpperCase() }}
                        </span>
                      </td>
                      <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-[#6B6B6B] text-xs">
                        {{ formatDate(domain.verified_at) }}
                      </td>
                      <td class="border-b border-[#0A0A0A]/20 p-3">
                        <div class="flex items-center gap-2">
                          <span :class="domain.markdown.active_count > 0 ? 'text-[#25D366]' : 'text-[#6B6B6B]'" class="font-mono font-bold">
                            {{ domain.markdown.active_count }}
                          </span>
                          <span class="text-[#6B6B6B] text-xs">/ {{ domain.markdown.total_versions }}</span>
                        </div>
                      </td>
                      <td class="border-b border-[#0A0A0A]/20 p-3">
                        <span :class="domain.pages.active_count > 0 ? 'text-[#0A0A0A]' : 'text-[#6B6B6B]'" class="font-mono">
                          {{ domain.pages.active_count }}
                        </span>
                      </td>
                      <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-[#0A0A0A]">
                        {{ domain.crouton_count }}
                      </td>
                      <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-[#6B6B6B] text-xs">
                        <span v-if="domain.days_since_activity === 0">Today</span>
                        <span v-else-if="domain.days_since_activity === 1">Yesterday</span>
                        <span v-else-if="domain.days_since_activity < 7">{{ domain.days_since_activity }}d ago</span>
                        <span v-else-if="domain.days_since_activity < 30">{{ Math.floor(domain.days_since_activity / 7) }}w ago</span>
                        <span v-else>{{ Math.floor(domain.days_since_activity / 30) }}mo ago</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div v-if="verified.error" class="mt-4 text-[#EF4444] text-xs md:text-sm font-mono">
              Error: {{ verified.error }}
            </div>
            
            <div v-if="verified.data && verified.data.length > 0" class="text-xs md:text-sm text-[#6B6B6B] font-mono mt-4">
              Showing {{ verified.data.length }} verified domains. Updated: {{ formatDate(verified.lastUpdated) }}
            </div>
          </div>
        </div>

        <!-- AI-Readable Sources Tab -->
        <div v-if="tab==='sources'">
          <div class="border-2 border-[#0A0A0A] p-4 md:p-8">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4 md:mb-6">
              <h2 class="text-xl md:text-2xl font-bold text-[#0A0A0A]">AI-Readable Sources</h2>
              <button @click="loadSourceStats" :disabled="sources.loading" class="w-full sm:w-auto px-6 py-3 md:py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer disabled:bg-[#6B6B6B] disabled:opacity-60 disabled:cursor-not-allowed touch-manipulation">
                {{ sources.loading ? 'Loading...' : 'Refresh' }}
              </button>
            </div>
            <div class="text-xs md:text-sm text-[#6B6B6B] mb-4 md:mb-6">
              All source domains with AI-readable content. Shows which sites expose Markdown and how it was discovered.
            </div>
            
            <div class="overflow-x-auto border-2 border-[#0A0A0A] rounded-lg -mx-2 md:mx-0">
              <div class="inline-block min-w-full">
                <table class="w-full border-collapse text-xs sm:text-sm min-w-[600px]">
                  <thead>
                    <tr>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Domain</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Markdown Exposed</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Discovery Method(s)</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Crouton Count</th>
                      <th class="border-b-2 border-[#0A0A0A] p-3 text-left font-bold text-[#0A0A0A] sticky top-0 bg-white">Last Observed</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="sources.loading">
                      <td colspan="5" class="text-[#6B6B6B] p-3 text-center">Loading source statistics...</td>
                    </tr>
                    <tr v-else-if="!sources.data || sources.data.length === 0">
                      <td colspan="5" class="text-[#6B6B6B] p-3 text-center">No source data available yet</td>
                    </tr>
                    <tr v-else v-for="source in sources.data" :key="source.domain" class="hover:bg-[#F8F8F8] transition-colors duration-200">
                      <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-[#0A0A0A]">{{ source.domain }}</td>
                      <td class="border-b border-[#0A0A0A]/20 p-3">
                        <span :class="source.markdown ? 'text-[#25D366]' : 'text-[#6B6B6B]'" class="font-mono">
                          {{ source.markdown ? 'YES' : 'NO' }}
                        </span>
                      </td>
                      <td class="border-b border-[#0A0A0A]/20 p-3">
                        <div class="flex flex-wrap gap-1">
                          <span v-for="method in source.discovery_methods" :key="method" class="px-2 py-1 text-xs rounded-full bg-[#F8F8F8] border border-[#0A0A0A] font-mono">
                            {{ method }}
                          </span>
                        </div>
                      </td>
                      <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-[#0A0A0A]">{{ source.crouton_count }}</td>
                      <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-[#6B6B6B]">{{ formatDate(source.last_seen) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div v-if="sources.error" class="mt-4 text-[#EF4444] text-xs md:text-sm font-mono">
              Error: {{ sources.error }}
            </div>
            
            <div v-if="sources.data && sources.data.length > 0" class="text-xs md:text-sm text-[#6B6B6B] font-mono mt-4">
              Showing {{ sources.data.length }} source domains. Updated: {{ formatDate(sources.lastUpdated) }}
            </div>
          </div>
        </div>

        <!-- URL Verification Tab -->
        <div v-if="tab==='urls'" class="mt-6">
          <div class="border-2 border-[#0A0A0A] p-4 md:p-8 rounded-lg">
            <div class="flex flex-col md:flex-row md:items-end gap-4 mb-6">
              <div class="w-full md:w-96">
                <label class="text-sm font-mono text-[#6B6B6B] mb-2 block">Select Domain</label>
                <select
                  class="w-full px-4 py-2 border-2 border-[#0A0A0A] rounded font-mono"
                  :value="urlVerification.selectedDomain"
                  @change="loadUrlsForDomain($event.target.value)">
                  <option value="">Choose domain…</option>
                  <option v-for="d in verified.data" :key="d.domain" :value="d.domain">
                    {{ d.domain }} ({{ d.health_status }})
                  </option>
                </select>
              </div>

              <div class="flex gap-3">
                <button
                  @click="loadUrlsForDomain(urlVerification.selectedDomain)"
                  :disabled="!urlVerification.selectedDomain || urlVerification.urls.loading"
                  class="px-6 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] rounded">
                  {{ urlVerification.urls.loading ? 'Loading…' : 'Refresh URLs' }}
                </button>
              </div>
            </div>

            <div v-if="urlVerification.urls.error" class="border-2 border-[#EF4444] p-3 rounded mb-4 font-mono text-xs">
              {{ urlVerification.urls.error }}
            </div>

            <div v-if="urlVerification.urls.data.length === 0" class="font-mono text-sm text-[#6B6B6B]">
              No URLs loaded yet. Select a domain.
            </div>

            <div v-if="urlVerification.urls.data.length > 0" class="overflow-x-auto border-2 border-[#0A0A0A] rounded-lg">
              <table class="w-full border-collapse text-xs sm:text-sm">
                <thead>
                  <tr>
                    <th class="border-b-2 border-[#0A0A0A] p-3 text-left">URL</th>
                    <th class="border-b-2 border-[#0A0A0A] p-3 text-left">Last Fetched</th>
                    <th class="border-b-2 border-[#0A0A0A] p-3 text-left">Extract Hash</th>
                    <th class="border-b-2 border-[#0A0A0A] p-3 text-left">Method</th>
                    <th class="border-b-2 border-[#0A0A0A] p-3 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="row in urlVerification.urls.data" :key="row.source_url">
                    <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-xs">
                      <a :href="row.source_url" target="_blank" class="underline hover:text-[#00C2FF]">
                        {{ row.source_url }}
                      </a>
                    </td>
                    <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-xs">{{ formatDate(row.fetched_at) }}</td>
                    <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-xs">
                      {{ (row.extraction_text_hash || '').slice(0, 8) }}{{ row.extraction_text_hash ? '…' : '—' }}
                    </td>
                    <td class="border-b border-[#0A0A0A]/20 p-3 font-mono text-xs">{{ row.extraction_method || '—' }}</td>
                    <td class="border-b border-[#0A0A0A]/20 p-3">
                      <div class="flex gap-2">
                        <button
                          @click="runProofBundle(urlVerification.selectedDomain, row.source_url)"
                          :disabled="urlVerification.proof.loading"
                          class="px-4 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] rounded">
                          {{ urlVerification.proof.loading ? 'Verifying…' : 'Verify' }}
                        </button>
                        <a
                          class="px-4 py-2 border-2 border-[#0A0A0A] font-medium hover:bg-[#F8F8F8] rounded"
                          :href="'https://md.croutons.ai/' + urlVerification.selectedDomain + '/' + mirrorPathFrom(row.source_url)"
                          target="_blank">
                          Mirror
                        </a>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-6 font-mono text-xs text-[#6B6B6B]">
              Quick links:
              <span v-if="urlVerification.selectedDomain">
                <a class="underline hover:text-[#00C2FF]" :href="'https://precogs.croutons.ai/v1/status/' + urlVerification.selectedDomain" target="_blank">status</a>
                ·
                <a class="underline hover:text-[#00C2FF]" :href="'https://precogs.croutons.ai/v1/extract/' + urlVerification.selectedDomain + '?url=' + encodeURIComponent('https://' + urlVerification.selectedDomain + '/')" target="_blank">extract</a>
                ·
                <a class="underline hover:text-[#00C2FF]" :href="'https://precogs.croutons.ai/v1/graph/' + urlVerification.selectedDomain + '.jsonld'" target="_blank">graph</a>
              </span>
            </div>
          </div>

          <!-- Proof Modal -->
          <div v-if="urlVerification.proof.show" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white max-w-5xl w-full max-h-[90vh] overflow-y-auto border-4 border-[#0A0A0A] p-6 md:p-8 rounded">
              <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                  <div class="text-xl font-bold">Proof Bundle</div>
                  <div class="font-mono text-xs text-[#6B6B6B] break-all">
                    {{ urlVerification.proof.data?.domain }} · {{ urlVerification.proof.data?.source_url }}
                  </div>
                </div>
                <button @click="urlVerification.proof.show=false" class="px-4 py-2 border-2 border-[#0A0A0A] font-medium hover:bg-[#F8F8F8] rounded">
                  Close
                </button>
              </div>

              <div v-if="urlVerification.proof.error" class="border-2 border-[#EF4444] p-3 rounded mb-4 font-mono text-xs">
                {{ urlVerification.proof.error }}
              </div>

              <div v-if="urlVerification.proof.data" class="mb-4">
                <div class="text-lg font-bold"
                     :class="urlVerification.proof.data.result.citation_grade_pass ? 'text-[#25D366]' : 'text-[#EF4444]'">
                  {{ urlVerification.proof.data.result.citation_grade_pass ? 'CITATION-GRADE PASS' : 'CITATION-GRADE FAIL' }}
                </div>
                <div class="font-mono text-xs"
                     :class="urlVerification.proof.data.result.full_protocol_pass ? 'text-[#25D366]' : 'text-[#6B6B6B]'">
                  {{ urlVerification.proof.data.result.full_protocol_pass ? 'FULL PROTOCOL PASS' : 'FULL PROTOCOL: NOT YET' }}
                </div>
              </div>

              <div class="flex flex-wrap gap-3 mb-4">
                <button @click="copyProofBundle" class="px-5 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] rounded">
                  Copy JSON
                </button>
                <button @click="downloadProofBundle" class="px-5 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] rounded">
                  Download JSON
                </button>
                <a v-if="urlVerification.proof.data?.mirror?.url"
                   class="px-5 py-2 border-2 border-[#0A0A0A] font-medium hover:bg-[#F8F8F8] rounded"
                   :href="urlVerification.proof.data.mirror.url"
                   target="_blank">
                  Open Mirror
                </a>
              </div>

              <pre class="bg-[#F8F8F8] p-4 rounded font-mono text-xs overflow-x-auto">
{{ JSON.stringify(urlVerification.proof.data, null, 2) }}
              </pre>
            </div>
          </div>

          <!-- Toast -->
          <div v-if="urlVerification.toast.show"
               class="fixed bottom-4 right-4 z-50 border-2 border-[#0A0A0A] bg-white px-4 py-3 rounded shadow font-mono text-xs"
               :class="{
                 'border-[#25D366]': urlVerification.toast.kind==='ok',
                 'border-[#FF9500]': urlVerification.toast.kind==='warn',
                 'border-[#EF4444]': urlVerification.toast.kind==='error'
               }">
            {{ urlVerification.toast.message }}
          </div>
        </div>

        <footer class="text-sm text-[#6B6B6B] font-mono text-center mt-8">
          Croutons ingestion and verification dashboard. Data updates on refresh.
        </footer>
      </div>
    </div>
  </section>

  <!-- Scripts -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    // Stats refresh
    async function refreshStats() {
      try {
        const res = await fetch("/diag/stats");
        const data = await res.json();
        document.getElementById("kpiCroutons").textContent = data.counts?.croutons ?? 0;
        document.getElementById("kpiTriples").textContent = data.counts?.triples ?? 0;
        document.getElementById("statsTime").textContent = new Date(data.time || Date.now()).toLocaleString();
      } catch (e) {
        document.getElementById("statsTime").textContent = "error";
        console.error(e);
      }
    }
    document.getElementById("btnRefreshStats").addEventListener("click", refreshStats);
    refreshStats();

    // Vue app
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          tab: 'verified',
          verified: {
            loading: false,
            error: null,
            data: [],
            lastUpdated: null
          },
          sources: {
            loading: false,
            error: null,
            data: [],
            lastUpdated: null
          },
          urlVerification: {
            selectedDomain: '',
            urls: { loading: false, data: [], error: null },
            proof: { show: false, loading: false, data: null, error: null },
            toast: { show: false, message: '', kind: 'info' }
          }
        }
      },
      computed: {
        verifiedHealthy() {
          if (!this.verified.data) return 0;
          return this.verified.data.filter(d => d.health_status === 'healthy').length;
        },
        totalActiveMarkdown() {
          if (!this.verified.data) return 0;
          return this.verified.data.reduce((sum, d) => sum + (d.markdown?.active_count || 0), 0);
        },
        totalCroutons() {
          if (!this.verified.data) return 0;
          return this.verified.data.reduce((sum, d) => sum + (d.crouton_count || 0), 0);
        }
      },
      watch: {
        tab(newTab) {
          if (newTab === 'verified') {
            this.loadVerifiedDomains();
          } else if (newTab === 'sources') {
            this.loadSourceStats();
          }
        }
      },
      methods: {
        async loadVerifiedDomains() {
          this.verified.loading = true;
          this.verified.error = null;
          try {
            const response = await fetch('/api/verified-domains?nocache=1', { 
              cache: 'no-store',
              headers: { 'Accept': 'application/json' }
            });
            if (!response.ok) throw new Error('HTTP ' + response.status);
            const payload = await response.json();
            this.verified.data = payload?.data || [];
            this.verified.lastUpdated = new Date().toISOString();
          } catch (error) {
            console.error('[verified] Error loading domains:', error);
            this.verified.error = error.message;
            this.verified.data = [];
          } finally {
            this.verified.loading = false;
          }
        },
        async loadSourceStats() {
          this.sources.loading = true;
          this.sources.error = null;
          try {
            const response = await fetch('/api/source-stats?nocache=1', { 
              cache: 'no-store',
              headers: { 'Accept': 'application/json' }
            });
            if (!response.ok) throw new Error('HTTP ' + response.status);
            const payload = await response.json();
            this.sources.data = payload?.data || [];
            this.sources.lastUpdated = new Date().toISOString();
          } catch (error) {
            console.error('[sources] Error loading stats:', error);
            this.sources.error = error.message;
            this.sources.data = [];
          } finally {
            this.sources.loading = false;
          }
        },
        formatDate(dateString) {
          if (!dateString) return 'Never';
          try {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          } catch {
            return dateString;
          }
        },
        setToast(message, kind = 'info') {
          this.urlVerification.toast = { show: true, message, kind };
          setTimeout(() => { this.urlVerification.toast.show = false; }, 2200);
        },
        mirrorPathFrom(sourceUrl) {
          try {
            const u = new URL(sourceUrl);
            let path = u.pathname || '/';
            path = path.replace(/\/+$/, '/');
            if (path === '/' || path === '') return 'index.md';
            path = path.replace(/^\/+/, '').replace(/\/+$/, '');
            return `${path}.md`;
          } catch {
            return 'index.md';
          }
        },
        async fetchSafely(url, opts = {}) {
          const res = await fetch(url, {
            cache: 'no-store',
            headers: { 'Accept': 'application/json', ...(opts.headers || {}) },
            ...opts
          });
          const text = await res.text();
          if (!res.ok) {
            const err = new Error(`HTTP ${res.status} for ${url}`);
            err.status = res.status;
            err.body = text.slice(0, 1000);
            throw err;
          }
          return { res, text };
        },
        parseNdjsonSafe(ndjsonText) {
          const lines = (ndjsonText || '').split('\n').map(l => l.trim()).filter(Boolean);
          const out = [];
          for (const line of lines) {
            try {
              out.push(JSON.parse(line));
            } catch {
              // Skip bad lines
            }
          }
          return out;
        },
        async loadUrlsForDomain(domain) {
          const d = (domain || '').trim();
          this.urlVerification.selectedDomain = d;
          this.urlVerification.urls.loading = true;
          this.urlVerification.urls.error = null;
          this.urlVerification.urls.data = [];
          try {
            const { text } = await this.fetchSafely(`/api/urls?domain=${encodeURIComponent(d)}`, {
              headers: { 'Accept': 'application/json' }
            });
            const payload = JSON.parse(text);
            if (!payload?.ok) throw new Error(payload?.error || 'Failed to load URLs');
            this.urlVerification.urls.data = payload.data || [];
            this.setToast(`Loaded ${payload.count || this.urlVerification.urls.data.length} URLs`, 'ok');
          } catch (e) {
            this.urlVerification.urls.error = e.message;
            this.setToast(`URLs load failed: ${e.message}`, 'error');
          } finally {
            this.urlVerification.urls.loading = false;
          }
        },
        async runProofBundle(domain, url) {
          const d = (domain || '').trim();
          const u = (url || '').trim();
          if (!d || !u) {
            this.setToast('Select a domain and URL first', 'error');
            return;
          }

          this.urlVerification.proof.loading = true;
          this.urlVerification.proof.error = null;
          this.urlVerification.proof.data = null;

          try {
            const statusUrl = `https://precogs.croutons.ai/v1/status/${encodeURIComponent(d)}`;
            const extractUrl = `https://precogs.croutons.ai/v1/extract/${encodeURIComponent(d)}?url=${encodeURIComponent(u)}`;

            const factsTextUrl =
              `https://precogs.croutons.ai/v1/facts/${encodeURIComponent(d)}.ndjson` +
              `?evidence_type=text_extraction&source_url=${encodeURIComponent(u)}`;

            const factsStructuredUrl =
              `https://precogs.croutons.ai/v1/facts/${encodeURIComponent(d)}.ndjson` +
              `?evidence_type=structured_data&source_url=${encodeURIComponent(u)}`;

            const mirrorPath = this.mirrorPathFrom(u);
            const mirrorUrl = `https://md.croutons.ai/${encodeURIComponent(d)}/${mirrorPath}`;

            const graphUrl = `https://precogs.croutons.ai/v1/graph/${encodeURIComponent(d)}.jsonld`;

            const [statusRaw, extractRaw, factsTextRaw, factsStructRaw, mirrorRaw, graphRaw] = await Promise.all([
              this.fetchSafely(statusUrl, { headers: { 'Accept': 'application/json' } }),
              this.fetchSafely(extractUrl, { headers: { 'Accept': 'application/json' } }),
              this.fetchSafely(factsTextUrl, { headers: { 'Accept': 'application/x-ndjson' } }),
              this.fetchSafely(factsStructuredUrl, { headers: { 'Accept': 'application/x-ndjson' } }),
              fetch(mirrorUrl, { cache: 'no-store' }).then(async r => ({ ok: r.ok, status: r.status, text: await r.text() })).catch(() => ({ ok: false, status: 0, text: '' })),
              fetch(graphUrl, { cache: 'no-store' }).then(async r => ({ ok: r.ok, status: r.status, text: await r.text() })).catch(() => ({ ok: false, status: 0, text: '' }))
            ]);

            const status = JSON.parse(statusRaw.text);
            const extract = JSON.parse(extractRaw.text);

            const textFacts = this.parseNdjsonSafe(factsTextRaw.text);
            const structuredFacts = this.parseNdjsonSafe(factsStructRaw.text);

            const mirrorText = mirrorRaw.ok ? mirrorRaw.text : '';
            let graph = null;
            try { graph = graphRaw.ok ? JSON.parse(graphRaw.text) : null; } catch { graph = null; }

            const citationGrade = Boolean(extract?.validation?.citation_grade);
            const passRate = Number(extract?.validation?.pass_rate ?? 0);
            const textCount = textFacts.length;

            const citationPass = citationGrade && passRate >= 0.95 && textCount >= 1;

            const mirrorHas11 =
              mirrorText.includes('markdown_version: "1.1"') &&
              mirrorText.includes('## Facts (Text Extraction) — Citation-Grade') &&
              mirrorText.includes('## Metadata (Structured Data) — Not Anchorable');

            const graphLen = Array.isArray(graph?.['@graph']) ? graph['@graph'].length : 0;

            const fullProtocolPass =
              status?.qa?.tier === 'full_protocol' &&
              mirrorHas11 &&
              graphLen > 0;

            const bundle = {
              domain: d,
              source_url: u,
              checked_at: new Date().toISOString(),
              endpoints: {
                status: statusUrl,
                extract: extractUrl,
                facts_text: factsTextUrl,
                facts_structured: factsStructuredUrl,
                mirror: mirrorUrl,
                graph: graphUrl
              },
              status: {
                qa: status?.qa || null,
                versions: status?.versions || null,
                counts: status?.counts || null
              },
              extract: {
                extraction_text_hash: extract?.extraction_text_hash ?? null,
                canonical_text_length: extract?.canonical_text_length ?? null,
                validation: extract?.validation ?? null,
                failed_examples: extract?.validation?.failed_examples ?? []
              },
              facts_counts: {
                text_extraction: textFacts.length,
                structured_data: structuredFacts.length
              },
              facts_text_extraction_sample: textFacts.slice(0, 5),
              mirror: {
                url: mirrorUrl,
                ok: mirrorRaw.ok,
                status: mirrorRaw.status,
                has_v1_1: mirrorHas11
              },
              graph: {
                ok: Boolean(graphRaw.ok),
                graph_length: graphLen
              },
              result: {
                citation_grade_pass: citationPass,
                full_protocol_pass: fullProtocolPass
              }
            };

            this.urlVerification.proof.data = bundle;
            this.urlVerification.proof.show = true;
            this.setToast(citationPass ? 'Citation-grade PASS' : 'Citation-grade FAIL', citationPass ? 'ok' : 'warn');
          } catch (e) {
            this.urlVerification.proof.error = `${e.message}${e.body ? ` | ${e.body}` : ''}`;
            this.setToast(`Verify failed: ${e.message}`, 'error');
          } finally {
            this.urlVerification.proof.loading = false;
          }
        },
        copyProofBundle() {
          const data = this.urlVerification.proof.data;
          if (!data) return;
          const json = JSON.stringify(data, null, 2);
          navigator.clipboard.writeText(json).then(
            () => this.setToast('Proof bundle copied', 'ok'),
            () => this.setToast('Clipboard copy failed', 'error')
          );
        },
        downloadProofBundle() {
          const data = this.urlVerification.proof.data;
          if (!data) return;
          const json = JSON.stringify(data, null, 2);
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `proof-bundle-${data.domain}-${Date.now()}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          this.setToast('Proof bundle downloaded', 'ok');
        }
      },
      mounted() {
        this.loadVerifiedDomains();
      }
    }).mount('#app');
  </script>
</body>
</html>
